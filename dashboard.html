<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Clinic Dashboard</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Inter Font -->
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        body { font-family: 'Inter', sans-serif; background-color: #f4f7f9; }
        .dashboard-card {
            background-color: #ffffff;
            border: 1px solid #e0e7ff; /* Indigo 100 */
            transition: all 0.2s ease-in-out;
        }
        /* Style for the sticky header in task lists */
        .sticky-header {
            position: sticky;
            top: 0;
            z-index: 10;
        }
        /* Modal Backdrop */
        .modal-backdrop {
            background-color: rgba(0, 0, 0, 0.5);
        }
    </style>
</head>
<body class="min-h-screen flex flex-col">

    <!-- Header -->
    <header class="bg-indigo-700 text-white shadow-lg p-4 flex justify-between items-center z-20">
        <div class="flex items-center space-x-3">
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 7v10h16V7M5 7L12 3l7 4M7 7h10"></path></svg>
            <span class="text-xl font-semibold">Clinic Dashboard</span>
        </div>
        <div class="flex items-center space-x-4">
            <span id="user-role-display" class="bg-indigo-600 text-xs font-medium px-3 py-1 rounded-full">Loading Role...</span>
            <span id="user-id-display" class="text-sm">User ID: N/A</span>
            <button id="logout-button" class="bg-red-500 hover:bg-red-600 transition duration-150 text-white font-medium py-2 px-4 rounded-lg shadow-md focus:outline-none focus:ring-2 focus:ring-red-500 focus:ring-opacity-50">Logout</button>
        </div>
    </header>

    <!-- Main Content -->
    <main class="flex-grow p-4 md:p-8">
        <div id="loading-overlay" class="fixed inset-0 bg-white/70 z-30 flex items-center justify-center hidden">
            <div class="flex flex-col items-center">
                <svg class="animate-spin h-10 w-10 text-indigo-700 mb-3" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                </svg>
                <p class="text-indigo-700 font-medium">Loading Dashboard Data...</p>
            </div>
        </div>

        <div id="main-dashboard-content" class="hidden">
            <!-- Grid Layout for Dashboard Cards -->
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-8">
                <!-- Patient Management Card -->
                <div class="dashboard-card p-6 rounded-xl shadow-lg border-l-4 border-indigo-500">
                    <h2 class="text-xl font-bold text-gray-700 mb-4 flex items-center">
                        <svg class="w-5 h-5 mr-2 text-indigo-500" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4.354a4 4 0 110 5.292M15 21H9a4 4 0 01-4-4v-2.586a1 1 0 01.293-.707l.793-.793a4 4 0 001.07-2.348v-2.12c0-1.168.93-2.115 2.083-2.115h2.167c1.153 0 2.083.947 2.083 2.115v2.12c0 .8.293 1.55.793 2.12l.793.793a1 1 0 01.293.707V17a4 4 0 01-4 4z"></path></svg>
                        Patient Management
                    </h2>
                    <p class="text-gray-500 mb-4">View and manage patient records.</p>
                    <button onclick="showAddPatientModal()" class="w-full bg-indigo-500 hover:bg-indigo-600 text-white font-medium py-2 rounded-lg transition duration-150 shadow-md">Add New Patient</button>
                    <div id="patient-list" class="mt-4 max-h-96 overflow-y-auto space-y-2">
                        <!-- Patient cards will be rendered here -->
                        <p class="text-center text-gray-400 p-4">Loading patients...</p>
                    </div>
                </div>

                <!-- Global Tasks Card -->
                <div class="dashboard-card p-6 rounded-xl shadow-lg border-l-4 border-emerald-500">
                    <h2 class="text-xl font-bold text-gray-700 mb-4 flex items-center">
                        <svg class="w-5 h-5 mr-2 text-emerald-500" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M9 16h.01"></path></svg>
                        Global Tasks
                    </h2>
                    <div class="flex space-x-2 mb-4">
                        <input type="text" id="new-task-input" placeholder="Enter new task" class="flex-grow p-2 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500">
                        <button onclick="addGlobalTask()" class="bg-emerald-500 hover:bg-emerald-600 text-white font-medium py-2 px-4 rounded-lg transition duration-150 shadow-md">Add</button>
                    </div>
                    <div id="task-list" class="max-h-96 overflow-y-auto space-y-2">
                        <!-- Tasks will be rendered here -->
                        <p class="text-center text-gray-400 p-4">No pending tasks.</p>
                    </div>
                </div>

                <!-- Inventory Card -->
                <div class="dashboard-card p-6 rounded-xl shadow-lg border-l-4 border-orange-500">
                    <h2 class="text-xl font-bold text-gray-700 mb-4 flex items-center">
                        <svg class="w-5 h-5 mr-2 text-orange-500" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m4 4v10m0-2.348l1.795-1.8m4.9-3.953L16 14.5"></path></svg>
                        Inventory Status
                    </h2>
                    <div id="inventory-list" class="max-h-96 overflow-y-auto space-y-3">
                        <!-- Inventory items will be rendered here -->
                        <p class="text-center text-gray-400 p-4">Loading inventory...</p>
                    </div>
                </div>
            </div>

            <!-- Consultation Reports & User Management Section -->
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                <!-- Consultation Reports Card (Spans 2 columns) -->
                <div class="dashboard-card lg:col-span-2 p-6 rounded-xl shadow-lg border-l-4 border-sky-500">
                    <h2 class="text-xl font-bold text-gray-700 mb-4 flex items-center">
                        <svg class="w-5 h-5 mr-2 text-sky-500" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path></svg>
                        Recent Consultation Reports
                    </h2>
                    <div id="reports-list" class="max-h-[500px] overflow-y-auto space-y-3">
                        <!-- Reports will be rendered here -->
                        <p class="text-center text-gray-400 p-4">Loading reports...</p>
                    </div>
                </div>

                <!-- User Management Card (Admin Only) -->
                <div id="user-management-card" class="dashboard-card p-6 rounded-xl shadow-lg border-l-4 border-pink-500 hidden">
                    <h2 class="text-xl font-bold text-gray-700 mb-4 flex items-center">
                        <svg class="w-5 h-5 mr-2 text-pink-500" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20h-5m5 0v-2a3 3 0 00-5.356-1.857M12 20v-2m-9 1l4-4m-2 2l2 2m10-4l4 4m-2-2l2-2"></path></svg>
                        User Roles (Admin)
                    </h2>
                    <div id="user-role-list" class="max-h-[500px] overflow-y-auto space-y-3">
                        <!-- User roles will be rendered here -->
                        <p class="text-center text-gray-400 p-4">Loading user roles...</p>
                    </div>
                </div>

            </div>
        </div>

    </main>

    <!-- ALERT BOX MODAL (Custom Alert/Confirm) -->
    <div id="alert-box-modal" class="fixed inset-0 modal-backdrop hidden items-center justify-center z-[100]">
        <div class="bg-white p-6 rounded-xl shadow-2xl w-full max-w-sm m-4 transform transition-all duration-300">
            <h3 id="alert-title" class="text-lg font-bold text-gray-800 mb-2">Alert</h3>
            <p id="alert-message" class="text-gray-600 mb-4">Message content.</p>
            <div id="alert-actions" class="flex justify-end space-x-3">
                <!-- Buttons will be dynamically added here -->
            </div>
        </div>
    </div>
    
    <!-- MODAL 1: ADD PATIENT -->
    <div id="add-patient-modal" class="fixed inset-0 modal-backdrop hidden items-center justify-center z-50">
        <div class="bg-white p-6 rounded-xl shadow-2xl w-full max-w-lg m-4 transform transition-all duration-300">
            <h3 class="text-2xl font-bold text-indigo-700 mb-4 border-b pb-2">Add New Patient</h3>
            <form id="add-patient-form">
                <div class="space-y-4">
                    <input type="text" id="patient-name" placeholder="Patient Name" required class="w-full p-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500">
                    <input type="date" id="patient-dob" required class="w-full p-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500">
                    <select id="patient-status" required class="w-full p-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500">
                        <option value="">Select Status</option>
                        <option value="Waiting">Waiting</option>
                        <option value="Consulting">Consulting</option>
                        <option value="Treated">Treated</option>
                    </select>
                </div>
                <div class="flex justify-end space-x-3 mt-6">
                    <button type="button" onclick="closeAddPatientModal()" class="px-4 py-2 text-gray-600 bg-gray-200 rounded-lg hover:bg-gray-300 transition duration-150">Cancel</button>
                    <button type="submit" class="px-4 py-2 bg-indigo-500 text-white rounded-lg hover:bg-indigo-600 transition duration-150 shadow-md">Add Patient</button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- MODAL 2: ADD CONSULTATION REPORT -->
    <div id="consultation-modal" class="fixed inset-0 modal-backdrop hidden items-center justify-center z-50">
        <div class="bg-white p-6 rounded-xl shadow-2xl w-full max-w-2xl m-4 transform transition-all duration-300">
            <h3 class="text-2xl font-bold text-sky-700 mb-4 border-b pb-2">Submit Consultation Report</h3>
            <form id="consultation-form">
                <div class="space-y-4">
                    <input type="text" id="report-patient-name" placeholder="Patient Name" required class="w-full p-3 border border-gray-300 rounded-lg focus:ring-sky-500 focus:border-sky-500">
                    <input type="text" id="report-title" placeholder="Report Title (e.g., Annual Checkup)" required class="w-full p-3 border border-gray-300 rounded-lg focus:ring-sky-500 focus:border-sky-500">
                    <textarea id="report-details" placeholder="Consultation Details and Findings" rows="6" required class="w-full p-3 border border-gray-300 rounded-lg focus:ring-sky-500 focus:border-sky-500"></textarea>
                </div>
                <div class="flex justify-end space-x-3 mt-6">
                    <button type="button" onclick="closeConsultationModal()" class="px-4 py-2 text-gray-600 bg-gray-200 rounded-lg hover:bg-gray-300 transition duration-150">Cancel</button>
                    <button type="submit" class="px-4 py-2 bg-sky-500 text-white rounded-lg hover:bg-sky-600 transition duration-150 shadow-md">Submit Report</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Firebase SDK Imports -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInWithCustomToken, signInAnonymously, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot, collection, query, addDoc, updateDoc, deleteDoc, where, getDoc, writeBatch } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Global Firebase Variables
        let app;
        let db;
        let auth;
        let userId;
        let userRole = 'nurse'; // Default role
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        setLogLevel('Debug'); // Enable Firestore logging

        // --- UTILITY FUNCTIONS ---
        
        // Custom Alert/Confirmation Box
        function alertBox(title, message, isConfirm = false, onConfirm = () => {}) {
            const modal = document.getElementById('alert-box-modal');
            document.getElementById('alert-title').textContent = title;
            document.getElementById('alert-message').textContent = message;
            const actions = document.getElementById('alert-actions');
            actions.innerHTML = '';
            
            const closeBtn = document.createElement('button');
            closeBtn.className = 'px-4 py-2 text-white bg-indigo-500 rounded-lg hover:bg-indigo-600 transition duration-150';
            closeBtn.textContent = 'OK';
            closeBtn.onclick = () => modal.classList.add('hidden');
            
            if (isConfirm) {
                const cancelBtn = document.createElement('button');
                cancelBtn.className = 'px-4 py-2 text-gray-600 bg-gray-200 rounded-lg hover:bg-gray-300 transition duration-150';
                cancelBtn.textContent = 'Cancel';
                cancelBtn.onclick = () => modal.classList.add('hidden');
                actions.appendChild(cancelBtn);
                
                const confirmBtn = document.createElement('button');
                confirmBtn.className = 'px-4 py-2 text-white bg-red-500 rounded-lg hover:bg-red-600 transition duration-150';
                confirmBtn.textContent = 'Confirm';
                confirmBtn.onclick = () => {
                    onConfirm();
                    modal.classList.add('hidden');
                };
                actions.appendChild(confirmBtn);
            } else {
                actions.appendChild(closeBtn);
            }

            modal.classList.remove('hidden');
        }

        // --- DASHBOARD RENDERING FUNCTIONS ---

        function renderPatients(patients) {
            const list = document.getElementById('patient-list');
            list.innerHTML = '';
            if (patients.length === 0) {
                list.innerHTML = '<p class="text-center text-gray-400 p-4">No patients registered.</p>';
                return;
            }

            patients.forEach(patient => {
                const age = new Date().getFullYear() - new Date(patient.dob).getFullYear();
                const card = document.createElement('div');
                card.className = 'bg-white p-3 border rounded-lg shadow-sm flex justify-between items-center transition duration-150 hover:shadow-md';
                
                const statusColor = patient.status === 'Waiting' ? 'bg-yellow-100 text-yellow-800' :
                                    patient.status === 'Consulting' ? 'bg-indigo-100 text-indigo-800' :
                                    'bg-green-100 text-green-800';
                
                card.innerHTML = `
                    <div>
                        <p class="font-semibold text-gray-800">${patient.name}</p>
                        <p class="text-sm text-gray-500">Age: ${age} | Status: <span class="${statusColor} text-xs font-medium px-2 py-0.5 rounded-full">${patient.status}</span></p>
                    </div>
                    <div class="flex space-x-2">
                        <button onclick="showConsultationModal('${patient.name}')" title="Add Report" class="text-sky-500 hover:text-sky-700 transition duration-150">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path></svg>
                        </button>
                        <select onchange="updatePatientStatus('${patient.id}', this.value)" class="text-sm p-1 border rounded-lg">
                            <option value="Waiting" ${patient.status === 'Waiting' ? 'selected' : ''}>Waiting</option>
                            <option value="Consulting" ${patient.status === 'Consulting' ? 'selected' : ''}>Consulting</option>
                            <option value="Treated" ${patient.status === 'Treated' ? 'selected' : ''}>Treated</option>
                        </select>
                    </div>
                `;
                list.appendChild(card);
            });
        }

        function renderTasks(tasks) {
            const list = document.getElementById('task-list');
            list.innerHTML = '';
            if (tasks.length === 0) {
                list.innerHTML = '<p class="text-center text-gray-400 p-4">No global tasks.</p>';
                return;
            }

            tasks.sort((a, b) => a.timestamp.toDate() - b.timestamp.toDate()); // Sort by creation time

            tasks.forEach(task => {
                const item = document.createElement('div');
                item.className = 'bg-white p-3 border rounded-lg shadow-sm flex justify-between items-center';
                item.innerHTML = `
                    <p class="text-gray-700">${task.description}</p>
                    <button onclick="deleteGlobalTask('${task.id}')" title="Delete Task" class="text-red-400 hover:text-red-600 transition duration-150">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
                    </button>
                `;
                list.appendChild(item);
            });
        }

        function renderInventory(inventory) {
            const list = document.getElementById('inventory-list');
            list.innerHTML = '';
            if (inventory.length === 0) {
                list.innerHTML = '<p class="text-center text-gray-400 p-4">Inventory is empty.</p>';
                return;
            }

            inventory.forEach(item => {
                const isLow = item.quantity < 10;
                const statusClass = isLow ? 'text-red-500 font-bold' : 'text-gray-700';
                
                const card = document.createElement('div');
                card.className = 'flex justify-between items-center bg-gray-50 p-3 rounded-lg border';
                card.innerHTML = `
                    <div>
                        <p class="font-medium text-gray-800">${item.name}</p>
                        <p class="text-sm ${statusClass}">Quantity: ${item.quantity}</p>
                        ${isLow ? '<p class="text-xs text-red-500">Low Stock!</p>' : ''}
                    </div>
                    <div class="flex items-center space-x-2">
                        <input type="number" min="0" value="${item.quantity}" id="qty-${item.id}" class="w-16 p-1 border rounded-lg text-center text-sm">
                        <button onclick="updateInventory('${item.id}', document.getElementById('qty-${item.id}').value)" class="text-indigo-500 hover:text-indigo-700 transition duration-150" title="Update Quantity">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path></svg>
                        </button>
                    </div>
                `;
                list.appendChild(card);
            });
        }

        function renderReports(reports) {
            const list = document.getElementById('reports-list');
            list.innerHTML = '';
            if (reports.length === 0) {
                list.innerHTML = '<p class="text-center text-gray-400 p-4">No consultation reports have been filed yet.</p>';
                return;
            }

            reports.sort((a, b) => b.timestamp.toDate() - a.timestamp.toDate()); // Sort by newest first

            reports.forEach(report => {
                const date = report.timestamp.toDate().toLocaleDateString();
                const time = report.timestamp.toDate().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
                
                const card = document.createElement('div');
                card.className = 'bg-white p-4 border rounded-xl shadow-md space-y-2';
                card.innerHTML = `
                    <div class="flex justify-between items-start">
                        <div>
                            <p class="text-lg font-bold text-sky-700">${report.title}</p>
                            <p class="text-sm font-medium text-gray-600">Patient: ${report.patientName}</p>
                        </div>
                        <div class="text-right">
                            <p class="text-xs text-gray-500">${date} at ${time}</p>
                            <p class="text-xs text-gray-500">Filed by: ${report.createdByRole}</p>
                            <button onclick="deleteConsultationReport('${report.id}')" title="Delete Report" class="text-red-400 hover:text-red-600 ml-2">
                                <svg class="w-4 h-4 inline-block" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
                            </button>
                        </div>
                    </div>
                    <p class="text-gray-700 text-sm italic border-t pt-2">${report.details.substring(0, 200)}${report.details.length > 200 ? '...' : ''}</p>
                `;
                list.appendChild(card);
            });
        }

        function renderUserRoles(users) {
            const list = document.getElementById('user-role-list');
            const adminCard = document.getElementById('user-management-card');
            
            // Only show the card if the current user is an admin
            if (userRole === 'admin') {
                adminCard.classList.remove('hidden');
            } else {
                adminCard.classList.add('hidden');
                return; // Stop execution if not admin
            }
            
            list.innerHTML = '';
            if (users.length === 0) {
                list.innerHTML = '<p class="text-center text-gray-400 p-4">No users found.</p>';
                return;
            }

            users.forEach(user => {
                const card = document.createElement('div');
                card.className = 'flex justify-between items-center bg-gray-50 p-3 rounded-lg border';
                card.innerHTML = `
                    <div>
                        <p class="font-medium text-gray-800">${user.id === userId ? 'You' : 'User'}</p>
                        <p class="text-xs text-gray-500 break-all">ID: ${user.id}</p>
                    </div>
                    <select onchange="updateUserRole('${user.id}', this.value)" class="text-sm p-1 border rounded-lg">
                        <option value="nurse" ${user.role === 'nurse' ? 'selected' : ''}>Nurse</option>
                        <option value="admin" ${user.role === 'admin' ? 'selected' : ''}>Admin</option>
                    </select>
                `;
                list.appendChild(card);
            });
        }
        
        // --- CRUD OPERATIONS ---

        async function addNewPatient(e) {
            e.preventDefault();
            const name = document.getElementById('patient-name').value;
            const dob = document.getElementById('patient-dob').value;
            const status = document.getElementById('patient-status').value;

            if (!name || !dob || !status) {
                alertBox('Error', 'Please fill in all patient details.');
                return;
            }
            
            try {
                const patientsRef = collection(db, 'artifacts', appId, 'public', 'data', 'patients');
                await addDoc(patientsRef, {
                    name,
                    dob,
                    status,
                    createdByUserId: userId,
                    createdByRole: userRole,
                    createdAt: new Date(),
                });
                closeAddPatientModal();
            } catch (error) {
                console.error("Error adding patient:", error);
                alertBox('Error', `Could not add patient. ${error.message}`);
            }
        }

        async function updatePatientStatus(patientId, newStatus) {
            try {
                const patientRef = doc(db, 'artifacts', appId, 'public', 'data', 'patients', patientId);
                await updateDoc(patientRef, {
                    status: newStatus
                });
            } catch (error) {
                console.error("Error updating patient status:", error);
                alertBox('Error', `Could not update patient status. ${error.message}`);
            }
        }
        
        async function updateInventory(itemId, newQuantity) {
            try {
                const itemRef = doc(db, 'artifacts', appId, 'public', 'data', 'inventory', itemId);
                await updateDoc(itemRef, {
                    quantity: parseInt(newQuantity, 10)
                });
            } catch (error) {
                console.error("Error updating inventory:", error);
                alertBox('Error', `Could not update inventory. ${error.message}`);
            }
        }

        async function addGlobalTask() {
            const input = document.getElementById('new-task-input');
            const description = input.value.trim();
            if (description === "") return;

            try {
                const tasksRef = collection(db, 'artifacts', appId, 'public', 'data', 'global_tasks');
                await addDoc(tasksRef, {
                    description: description,
                    isComplete: false,
                    timestamp: new Date()
                });
                input.value = '';
            } catch (error) {
                console.error("Error adding task:", error);
                alertBox('Error', `Could not add task. ${error.message}`);
            }
        }

        function deleteGlobalTask(taskId) {
            alertBox('Confirm Delete', 'Are you sure you want to delete this task?', true, async () => {
                try {
                    const taskRef = doc(db, 'artifacts', appId, 'public', 'data', 'global_tasks', taskId);
                    await deleteDoc(taskRef);
                } catch (error) {
                    console.error("Error deleting task:", error);
                    alertBox('Error', `Could not delete task. ${error.message}`);
                }
            });
        }
        
        function deleteConsultationReport(reportId) {
            alertBox('Confirm Delete', 'Are you sure you want to delete this report? This action is permanent.', true, async () => {
                try {
                    const reportRef = doc(db, 'artifacts', appId, 'public', 'data', 'consultation_reports', reportId);
                    await deleteDoc(reportRef);
                } catch (error) {
                    console.error("Error deleting report:", error);
                    alertBox('Error', `Could not delete report. ${error.message}`);
                }
            });
        }
        
        async function submitConsultationReport(e) {
            e.preventDefault();
            const patientName = document.getElementById('report-patient-name').value;
            const title = document.getElementById('report-title').value;
            const details = document.getElementById('report-details').value;

            if (!patientName || !title || !details) {
                alertBox('Error', 'Please fill in all report fields.');
                return;
            }

            try {
                const reportsRef = collection(db, 'artifacts', appId, 'public', 'data', 'consultation_reports');
                await addDoc(reportsRef, {
                    patientName,
                    title,
                    details,
                    createdByUserId: userId,
                    createdByRole: userRole,
                    timestamp: new Date()
                });
                closeConsultationModal();
            } catch (error) {
                console.error("Error submitting report:", error);
                alertBox('Error', `Could not submit report. ${error.message}`);
            }
        }

        async function updateUserRole(targetUserId, newRole) {
            try {
                const userRoleRef = doc(db, 'artifacts', appId, 'public', 'data', 'user_roles', targetUserId);
                await setDoc(userRoleRef, { role: newRole, lastUpdated: new Date() }, { merge: true });
                
                // If the current user changes their own role, the listener will update the state
                if (targetUserId === userId) {
                    userRole = newRole;
                    document.getElementById('user-role-display').textContent = newRole.charAt(0).toUpperCase() + newRole.slice(1);
                }
            } catch (error) {
                console.error("Error updating user role:", error);
                alertBox('Error', `Could not update role. ${error.message}`);
            }
        }
        
        // --- MODAL CONTROLS ---

        function showAddPatientModal() {
            document.getElementById('add-patient-modal').classList.remove('hidden');
        }

        function closeAddPatientModal() {
            document.getElementById('add-patient-form').reset();
            document.getElementById('add-patient-modal').classList.add('hidden');
        }
        
        function showConsultationModal(patientName = '') {
            document.getElementById('report-patient-name').value = patientName;
            document.getElementById('consultation-modal').classList.remove('hidden');
        }

        function closeConsultationModal() {
            document.getElementById('consultation-form').reset();
            document.getElementById('consultation-modal').classList.add('hidden');
        }
        
        function handleLogout() {
            signOut(auth).then(() => {
                // Redirect to login page after sign out
                window.location.href = 'index.html';
            }).catch((error) => {
                console.error("Logout failed:", error);
                alertBox('Logout Error', 'Could not log out successfully. Please try again.');
            });
        }

        // --- FIREBASE INITIALIZATION AND LISTENERS ---
        
        async function loadInitialData() {
            // Set up all real-time listeners AFTER authentication is confirmed
            const loadingOverlay = document.getElementById('loading-overlay');
            const mainContent = document.getElementById('main-dashboard-content');
            loadingOverlay.classList.remove('hidden');
            mainContent.classList.add('hidden');

            // 1. Listen for Patients
            const patientsRef = collection(db, 'artifacts', appId, 'public', 'data', 'patients');
            onSnapshot(patientsRef, (snapshot) => {
                const patients = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderPatients(patients);
            }, (error) => console.error("Patient Listener Error:", error));

            // 2. Listen for Global Tasks
            const tasksRef = collection(db, 'artifacts', appId, 'public', 'data', 'global_tasks');
            onSnapshot(tasksRef, (snapshot) => {
                const tasks = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderTasks(tasks);
            }, (error) => console.error("Task Listener Error:", error));

            // 3. Listen for Inventory
            const inventoryRef = collection(db, 'artifacts', appId, 'public', 'data', 'inventory');
            onSnapshot(inventoryRef, (snapshot) => {
                const inventory = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderInventory(inventory);
            }, (error) => console.error("Inventory Listener Error:", error));

            // 4. Listen for Consultation Reports
            const reportsRef = collection(db, 'artifacts', appId, 'public', 'data', 'consultation_reports');
            onSnapshot(reportsRef, (snapshot) => {
                const reports = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderReports(reports);
            }, (error) => console.error("Reports Listener Error:", error));

            // 5. Listen for User Roles
            const rolesRef = collection(db, 'artifacts', appId, 'public', 'data', 'user_roles');
            onSnapshot(rolesRef, (snapshot) => {
                const userRoles = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderUserRoles(userRoles);
                
                // Hide loading overlay and show content once initial data is loaded
                loadingOverlay.classList.add('hidden');
                mainContent.classList.remove('hidden');
            }, (error) => console.error("User Role Listener Error:", error));
            
        }

        async function initFirebase() {
            try {
                if (Object.keys(firebaseConfig).length === 0) {
                    throw new Error("Firebase configuration is missing.");
                }
                
                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                
                // Add logout handler
                document.getElementById('logout-button').addEventListener('click', handleLogout);

                // --- CRITICAL CHANGE: Use onAuthStateChanged for Auth Guard ---
                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        userId = user.uid;
                        document.getElementById('user-id-display').textContent = `User ID: ${userId}`;

                        // Check and set user role
                        const userRoleRef = doc(db, 'artifacts', appId, 'public', 'data', 'user_roles', userId);
                        const roleSnap = await getDoc(userRoleRef);
                        
                        if (roleSnap.exists()) {
                            userRole = roleSnap.data().role;
                        } else {
                            // First-time sign-in: Set default role to 'nurse'
                            userRole = 'nurse';
                            await setDoc(userRoleRef, { role: userRole, lastUpdated: new Date() });
                        }
                        
                        document.getElementById('user-role-display').textContent = userRole.charAt(0).toUpperCase() + userRole.slice(1);
                        
                        // Proceed to load data and set up listeners
                        loadInitialData();

                    } else {
                        // NO USER: Redirect back to login page (Auth Guard)
                        console.log("No authenticated user found. Redirecting to login.");
                        window.location.href = 'index.html';
                    }
                });

            } catch (e) {
                console.error("Firebase initialization failed:", e);
                alertBox('Initialization Error', `System failed to start: ${e.message}`);
                // Ensure no continuous loop by manually logging out if an error occurs
                window.location.href = 'index.html';
            }
        }
        
        // Expose functions globally for use in HTML attributes
        window.addNewPatient = addNewPatient;
        window.submitConsultationReport = submitConsultationReport;
        window.updateInventory = updateInventory;
        window.updatePatientStatus = updatePatientStatus;
        window.alertBox = alertBox;
        window.updateUserRole = updateUserRole; 
        window.addGlobalTask = addGlobalTask;     
        window.deleteGlobalTask = deleteGlobalTask; 
        window.deleteConsultationReport = deleteConsultationReport; 

        // Patient Management
        window.showAddPatientModal = showAddPatientModal;
        window.closeAddPatientModal = closeAddPatientModal;
        
        // Consultation Report Management 
        window.showConsultationModal = showConsultationModal;
        window.closeConsultationModal = closeConsultationModal;
        
        // Listen for form submissions
        document.addEventListener('DOMContentLoaded', () => {
            const addPatientForm = document.getElementById('add-patient-form');
            if (addPatientForm) {
                addPatientForm.addEventListener('submit', window.addNewPatient);
            }
            
            const consultationForm = document.getElementById('consultation-form');
            if (consultationForm) {
                consultationForm.addEventListener('submit', window.submitConsultationReport);
            }
        });

        // 2. Initialize Firebase and listeners on window load
        window.onload = initFirebase;
    </script>
</body>
</html>
