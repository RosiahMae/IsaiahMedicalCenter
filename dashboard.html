<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Role-Based Healthcare Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        body { font-family: 'Inter', sans-serif; }
        .dashboard-card {
            background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%);
            border: 1px solid #bae6fd; /* Light Blue 200 */
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">

    <div id="app" class="flex flex-col h-screen">
        <!-- Header -->
        <header class="bg-blue-800 text-white shadow-lg p-4 flex justify-between items-center z-10">
            <h1 class="text-2xl font-bold">HealthTrack Dashboard</h1>
            <div id="user-info" class="flex items-center space-x-4 text-sm">
                <!-- User info will be rendered here -->
            </div>
        </header>

        <!-- Main Content Area -->
        <main class="flex-grow p-4 md:p-8 overflow-y-auto">
            <div id="loading" class="text-center p-8 text-blue-600 font-semibold">
                Loading dashboard and verifying authentication...
            </div>
            <div id="content" class="hidden">
                <!-- Role-specific content will be injected here -->
            </div>
        </main>
    </div>

    <!-- Firebase Imports and Logic -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, onSnapshot, collection, query, addDoc, deleteDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Set Firebase logging level for development (remove in production)
        setLogLevel('debug');

        // Global state and Firebase references
        let db;
        let auth;
        let appId;
        let unsubscribeTasks = () => {};
        let unsubscribeUsers = () => {};

        const state = {
            isAuthReady: false,
            userId: null,
            currentRole: 'Loading',
            displayName: 'Guest',
            users: [], // Used by Admin for user management
            tasks: [], // Global tasks/announcements
        };

        // Utility: Fallback for crypto.randomUUID()
        const getUUID = () => typeof crypto !== 'undefined' && crypto.randomUUID ? crypto.randomUUID() : Math.random().toString(36).substring(2, 15);

        // --- CORE FIREBASE/AUTH SETUP (MANDATORY GLOBALS) ---
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : null;
        appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

        if (!firebaseConfig) {
            console.error("Firebase config not found. The app will not connect to Firestore.");
            document.getElementById('loading').textContent = "ERROR: Firebase configuration is missing.";
        } else {
            const app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            auth = getAuth(app);
            
            initAuthListener();
        }

        // --- FIRESTORE PATHS ---
        const getProfileDocRef = (uid) => doc(db, `artifacts/${appId}/public/data/profiles`, uid);
        const getTasksCollectionRef = () => collection(db, `artifacts/${appId}/public/data/dashboard_tasks`);
        const getUsersCollectionRef = () => collection(db, `artifacts/${appId}/public/data/profiles`);


        // --- AUTHENTICATION AND ROLE MANAGEMENT ---

        function initAuthListener() {
            onAuthStateChanged(auth, async (user) => {
                if (user) {
                    state.userId = user.uid;
                    state.displayName = user.displayName || `User-${user.uid.substring(0, 4)}`;
                    
                    await ensureUserProfile(user.uid, state.displayName);
                    
                } else {
                    // Sign in with token or anonymously
                    try {
                        if (typeof __initial_auth_token !== 'undefined') {
                            await signInWithCustomToken(auth, __initial_auth_token);
                        } else {
                            await signInAnonymously(auth);
                        }
                    } catch (error) {
                        console.error("Authentication failed:", error);
                        state.isAuthReady = true;
                        state.userId = getUUID(); // Placeholder for UI rendering
                        state.currentRole = 'Unauthenticated';
                        render();
                    }
                }
            });
        }

        // Ensures every signed-in user has a profile document with a role.
        async function ensureUserProfile(uid, defaultName) {
            try {
                const profileRef = getProfileDocRef(uid);
                const docSnap = await getDoc(profileRef);

                if (docSnap.exists()) {
                    const data = docSnap.data();
                    state.currentRole = data.role;
                    state.displayName = data.displayName || defaultName;
                    state.isAuthReady = true;
                    console.log(`User profile found. Role: ${state.currentRole}`);
                } else {
                    // Default new users to Patient role
                    const newProfile = {
                        userId: uid,
                        role: 'Patient', // Default role
                        displayName: defaultName,
                        createdAt: serverTimestamp(),
                    };
                    await setDoc(profileRef, newProfile);
                    state.currentRole = 'Patient';
                    state.isAuthReady = true;
                    console.log(`New user profile created. Role: ${state.currentRole}`);
                }
                
                // Start real-time listeners only after role is confirmed
                startDataListeners();
                render();

            } catch (error) {
                console.error("Error ensuring user profile:", error);
                state.isAuthReady = true;
                state.currentRole = 'Error';
                render();
            }
        }

        // --- REAL-TIME DATA LISTENERS ---

        function startDataListeners() {
            if (!db || !state.isAuthReady) return;

            // Stop previous listeners
            unsubscribeTasks();
            unsubscribeUsers();

            // 1. Listen for Tasks/Announcements
            const tasksQ = query(getTasksCollectionRef());
            unsubscribeTasks = onSnapshot(tasksQ, (snapshot) => {
                state.tasks = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                // Sort tasks by timestamp (newest first)
                state.tasks.sort((a, b) => (b.createdAt?.toMillis() || 0) - (a.createdAt?.toMillis() || 0));
                render();
            }, (error) => {
                console.error("Error listening to tasks:", error);
            });

            // 2. Listen for All Users (Required for Admin only, but useful to keep in sync)
            const usersQ = query(getUsersCollectionRef());
            unsubscribeUsers = onSnapshot(usersQ, (snapshot) => {
                state.users = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                render();
            }, (error) => {
                console.error("Error listening to users:", error);
            });
        }

        // --- ADMIN ACTIONS ---

        async function updateRole(targetUserId, newRole) {
            if (state.currentRole !== 'Admin') return console.warn("Only Admins can update roles.");
            try {
                const profileRef = getProfileDocRef(targetUserId);
                await setDoc(profileRef, { role: newRole }, { merge: true });
                console.log(`Successfully updated ${targetUserId}'s role to ${newRole}`);
            } catch (e) {
                console.error("Error updating role:", e);
                // Simple error display (replace with modal in a production app)
                document.getElementById('admin-message').textContent = `Failed to update role: ${e.message}`;
            }
        }

        async function postAnnouncement(e) {
            e.preventDefault();
            const form = e.target;
            const content = form.taskContent.value.trim();
            const targetRole = form.targetRole.value;

            if (!content) return;

            try {
                await addDoc(getTasksCollectionRef(), {
                    content: content,
                    target: targetRole,
                    postedBy: state.displayName,
                    postedById: state.userId,
                    createdAt: serverTimestamp(),
                });
                form.reset();
            } catch (e) {
                console.error("Error posting announcement:", e);
            }
        }
        
        async function deleteTask(taskId) {
            if (state.currentRole !== 'Admin') return console.warn("Only Admins can delete tasks.");
            try {
                await deleteDoc(doc(db, `artifacts/${appId}/public/data/dashboard_tasks`, taskId));
            } catch (e) {
                console.error("Error deleting task:", e);
            }
        }

        // --- NURSE ACTIONS (Simulated) ---

        function updatePatientStatus(patientId, newStatus) {
            console.log(`Simulated action: Updating patient ${patientId} status to ${newStatus}`);
            // In a real app, this would update a patient document in Firestore
        }
        
        // --- UI RENDERING ---

        function renderUserInfo() {
            const userInfoDiv = document.getElementById('user-info');
            userInfoDiv.innerHTML = `
                <span class="px-3 py-1 bg-yellow-400 text-gray-900 font-semibold rounded-full text-xs uppercase shadow">
                    ${state.currentRole}
                </span>
                <span class="text-xs md:text-sm font-medium">
                    ${state.displayName}
                </span>
                <span class="text-xs opacity-75 hidden md:inline-block">
                    (ID: ${state.userId ? state.userId.substring(0, 8) : 'N/A'})
                </span>
            `;
        }

        function renderAdminDashboard() {
            const adminUsers = state.users.filter(u => u.id !== state.userId);
            return `
                <div class="space-y-10">
                    <h2 class="text-3xl font-extrabold text-blue-900">Admin Control Panel</h2>
                    <p id="admin-message" class="text-red-500 font-medium"></p>

                    <!-- User Management Panel -->
                    <div class="dashboard-card p-6 rounded-xl shadow-xl">
                        <h3 class="text-2xl font-semibold text-blue-800 border-b pb-3 mb-4">User Role Management (${adminUsers.length} Others)</h3>
                        <div class="overflow-x-auto">
                            <table class="min-w-full divide-y divide-blue-200">
                                <thead class="bg-blue-100">
                                    <tr>
                                        <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">User ID</th>
                                        <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Display Name</th>
                                        <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Current Role</th>
                                        <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Action</th>
                                    </tr>
                                </thead>
                                <tbody class="bg-white divide-y divide-gray-200">
                                    ${adminUsers.map(user => `
                                        <tr>
                                            <td class="px-3 py-2 whitespace-nowrap text-sm text-gray-900 font-mono">${user.id.substring(0, 8)}...</td>
                                            <td class="px-3 py-2 whitespace-nowrap text-sm text-gray-700">${user.displayName || 'Unknown'}</td>
                                            <td class="px-3 py-2 whitespace-nowrap text-sm font-semibold">
                                                <span class="px-2 inline-flex text-xs leading-5 rounded-full ${user.role === 'Admin' ? 'bg-red-100 text-red-800' : user.role === 'Nurse' ? 'bg-green-100 text-green-800' : 'bg-gray-100 text-gray-800'}">
                                                    ${user.role}
                                                </span>
                                            </td>
                                            <td class="px-3 py-2 whitespace-nowrap text-sm font-medium">
                                                <select id="role-select-${user.id}" class="p-2 border border-gray-300 rounded-lg text-sm bg-white" onchange="window.updateRole('${user.id}', this.value)">
                                                    <option value="Admin" ${user.role === 'Admin' ? 'selected' : ''}>Admin</option>
                                                    <option value="Nurse" ${user.role === 'Nurse' ? 'selected' : ''}>Nurse</option>
                                                    <option value="Patient" ${user.role === 'Patient' ? 'selected' : ''}>Patient</option>
                                                </select>
                                            </td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <!-- Announcement/Task Posting Panel -->
                    <div class="dashboard-card p-6 rounded-xl shadow-xl">
                        <h3 class="text-2xl font-semibold text-blue-800 border-b pb-3 mb-4">Post Global Task/Announcement</h3>
                        <form id="post-announcement-form" class="space-y-4">
                            <div>
                                <label for="target-role" class="block text-sm font-medium text-gray-700">Target Audience</label>
                                <select name="targetRole" id="target-role" class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm rounded-md">
                                    <option value="All">All Users (Announcement)</option>
                                    <option value="Nurse">Nurses Only (Operational Task)</option>
                                    <option value="Admin">Admins Only (System Note)</option>
                                </select>
                            </div>
                            <div>
                                <label for="task-content" class="block text-sm font-medium text-gray-700">Content / Message</label>
                                <textarea name="taskContent" id="task-content" rows="3" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2 focus:ring-blue-500 focus:border-blue-500" placeholder="Type the task or announcement details..."></textarea>
                            </div>
                            <button type="submit" class="w-full py-2 px-4 border border-transparent rounded-lg shadow-sm text-sm font-medium text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition duration-150">
                                Post Announcement
                            </button>
                        </form>
                    </div>

                     <!-- Display Global Tasks -->
                    ${renderTasksList(true)}
                </div>
            `;
        }

        function renderNurseDashboard() {
            // Simulated data for Patient Assignments
            const assignedPatients = [
                { id: 'pat-1001', name: 'Alice M.', room: '301', status: 'Stable' },
                { id: 'pat-1002', name: 'Bob J.', room: '512', status: 'Requires Attention' },
                { id: 'pat-1003', name: 'Carol K.', room: '105', status: 'Discharge Pending' }
            ];

            return `
                <div class="space-y-10">
                    <h2 class="text-3xl font-extrabold text-green-700">Nurse Daily Operations</h2>
                    
                    <!-- Patient Assignment Card -->
                    <div class="dashboard-card p-6 rounded-xl shadow-xl">
                        <h3 class="text-2xl font-semibold text-green-600 border-b pb-3 mb-4">Assigned Patients (${assignedPatients.length})</h3>
                        <div class="space-y-4">
                            ${assignedPatients.map(patient => `
                                <div class="bg-white p-4 rounded-lg shadow flex justify-between items-center transition hover:shadow-md">
                                    <div>
                                        <p class="font-bold text-lg text-gray-800">${patient.name} - Room ${patient.room}</p>
                                        <p class="text-sm ${patient.status === 'Requires Attention' ? 'text-red-500 font-semibold' : 'text-gray-500'}">Status: ${patient.status}</p>
                                    </div>
                                    <select class="p-2 border border-gray-300 rounded-lg text-sm bg-gray-50" onchange="window.updatePatientStatus('${patient.id}', this.value)">
                                        <option value="Stable" ${patient.status === 'Stable' ? 'selected' : ''}>Stable</option>
                                        <option value="Requires Attention" ${patient.status === 'Requires Attention' ? 'selected' : ''}>Requires Attention</option>
                                        <option value="Discharge Pending" ${patient.status === 'Discharge Pending' ? 'selected' : ''}>Discharge Pending</option>
                                    </select>
                                </div>
                            `).join('')}
                        </div>
                        <p class="text-sm text-gray-500 mt-4 italic">Note: Patient status updates are simulated for this demo.</p>
                    </div>
                    
                    <!-- Task Board -->
                    ${renderTasksList(false, ['All', 'Nurse'])}
                </div>
            `;
        }

        function renderPatientDashboard() {
            return `
                <div class="space-y-8">
                    <h2 class="text-3xl font-extrabold text-blue-600">Patient Information Portal</h2>
                    
                    <!-- Welcome Card -->
                    <div class="dashboard-card p-6 rounded-xl shadow-xl">
                        <p class="text-lg text-gray-700">Welcome, <span class="font-semibold">${state.displayName}</span>!</p>
                        <p class="text-sm text-gray-500 mt-2">This is your personal information dashboard. You can view general hospital announcements and check your profile status here. Your assigned ID is <span class="font-mono bg-gray-100 px-1 rounded">${state.userId.substring(0, 8)}...</span></p>
                    </div>

                    <!-- Announcements -->
                    ${renderTasksList(false, ['All'])}
                </div>
            `;
        }

        function renderTasksList(showAdminControls = false, filterRoles = ['All', 'Nurse', 'Admin']) {
            const filteredTasks = state.tasks.filter(t => filterRoles.includes(t.target));

            if (filteredTasks.length === 0) {
                 return `
                    <div class="dashboard-card p-6 rounded-xl shadow-xl">
                        <h3 class="text-2xl font-semibold text-blue-800 border-b pb-3 mb-4">Announcements & Tasks</h3>
                        <p class="text-gray-500">No active announcements or tasks for your role at this time.</p>
                    </div>
                 `;
            }

            return `
                <div class="dashboard-card p-6 rounded-xl shadow-xl">
                    <h3 class="text-2xl font-semibold text-blue-800 border-b pb-3 mb-4">Announcements & Tasks</h3>
                    <div class="space-y-4">
                        ${filteredTasks.map(task => `
                            <div class="p-4 rounded-lg ${task.target === 'Nurse' ? 'bg-yellow-50 border-l-4 border-yellow-500' : task.target === 'Admin' ? 'bg-red-50 border-l-4 border-red-500' : 'bg-white border-l-4 border-blue-500'} shadow-sm">
                                <div class="flex justify-between items-start">
                                    <div>
                                        <p class="font-medium text-gray-800">${task.content}</p>
                                        <p class="text-xs text-gray-500 mt-1">
                                            Posted by <span class="font-semibold">${task.postedBy}</span>
                                            ${task.createdAt ? ` on ${new Date(task.createdAt.toMillis()).toLocaleString()}` : ''}
                                            <span class="ml-2 px-2 py-0.5 text-xs rounded-full font-bold ${task.target === 'All' ? 'bg-blue-200 text-blue-800' : task.target === 'Nurse' ? 'bg-yellow-200 text-yellow-800' : 'bg-red-200 text-red-800'}">${task.target}</span>
                                        </p>
                                    </div>
                                    ${showAdminControls ? `
                                        <button class="text-red-500 hover:text-red-700 p-1 rounded-full transition" onclick="window.deleteTask('${task.id}')">
                                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                                                <path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z" clip-rule="evenodd" />
                                            </svg>
                                        </button>
                                    ` : ''}
                                </div>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;
        }

        // Main render function
        function render() {
            const contentDiv = document.getElementById('content');
            const loadingDiv = document.getElementById('loading');
            
            if (!state.isAuthReady) {
                loadingDiv.classList.remove('hidden');
                contentDiv.classList.add('hidden');
                return;
            }

            loadingDiv.classList.add('hidden');
            contentDiv.classList.remove('hidden');
            
            renderUserInfo();

            let contentHTML = '';
            switch (state.currentRole) {
                case 'Admin':
                    contentHTML = renderAdminDashboard();
                    break;
                case 'Nurse':
                    contentHTML = renderNurseDashboard();
                    break;
                case 'Patient':
                    contentHTML = renderPatientDashboard();
                    break;
                default:
                    contentHTML = `<div class="p-8 text-center text-red-500">Access Denied or Unknown Role: ${state.currentRole}</div>`;
                    break;
            }
            contentDiv.innerHTML = contentHTML;
            
            // Re-attach event listeners after innerHTML update
            if (state.currentRole === 'Admin') {
                const form = document.getElementById('post-announcement-form');
                if (form) {
                    form.addEventListener('submit', postAnnouncement);
                }
            }
        }
        
        // Expose functions to the global scope for inline event handlers (like onclick)
        window.updateRole = updateRole;
        window.postAnnouncement = postAnnouncement;
        window.deleteTask = deleteTask;
        window.updatePatientStatus = updatePatientStatus; // Exposed simulated function
        
        // Initial render (will be updated by the auth listener)
        render();

    </script>
</body>
</html>
