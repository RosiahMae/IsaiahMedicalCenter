<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Clinic Dashboard</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Inter Font -->
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');
        body { font-family: 'Inter', sans-serif; background-color: #f4f7f9; }
        .dashboard-card {
            background-color: #ffffff;
            border: 1px solid #e0e7ff; /* Indigo 100 */
            transition: all 0.2s ease-in-out;
        }
        .sticky-header {
            position: sticky;
            top: 0;
            z-index: 10;
        }
        .modal-backdrop {
            background-color: rgba(0, 0, 0, 0.5);
        }
        .scrollable-list { max-height: 450px; overflow-y: auto; }
        /* Style for low stock */
        .low-stock { animation: pulse 1s infinite alternate; }
        @keyframes pulse {
            from { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7); }
            to { box-shadow: 0 0 0 5px rgba(239, 68, 68, 0); }
        }
    </style>
</head>
<body class="min-h-screen flex flex-col">

    <!-- ADDED: Complete JavaScript Logic to Fix Issues -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, addDoc, setDoc, updateDoc, deleteDoc, onSnapshot, collection, query, runTransaction, getDocs, where, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Global Firebase and App variables
        let app;
        let db;
        let auth;
        let userId = 'unknown'; 
        let appId = 'default-app-id';
        let currentUserRole = 'Guest';
        let isAuthReady = false;
        let inventorySeeded = false;

        // --- Utility Functions & Data Paths ---

        /** * Generates a firestore path for PUBLIC/SHARED data. CRITICAL FIX for shared data. */
        const getPublicCollectionRef = (collectionName) => {
            if (!db) return null;
            return collection(db, `artifacts/${appId}/public/data/${collectionName}`);
        };

        /** Fetches the current user's role (using a simple public collection for roles) */
        const fetchUserRole = async (uid) => {
            const userDocRef = doc(getPublicCollectionRef('roles'), uid);
            try {
                const docSnap = await getDoc(userDocRef);
                // Assign a default role if user is new, otherwise load existing role
                const role = docSnap.exists() ? docSnap.data().role : 'Nurse'; 
                return role;
            } catch (e) {
                console.error("Error fetching user role, defaulting to Nurse:", e);
                return 'Nurse'; // Default to Nurse if lookup fails
            }
        };
        
        // --- State Management ---
        let patientsData = [];
        let consultationsData = [];
        let inventoryData = [];

        // --- UI Modal Functions (Replaces alert/confirm) ---

        const alertBox = (title, message, type = 'info') => {
            const modal = document.getElementById('alert-modal');
            const titleEl = document.getElementById('alert-title');
            const messageEl = document.getElementById('alert-message');

            titleEl.textContent = title;
            messageEl.textContent = message;

            titleEl.className = 'text-xl font-bold';
            titleEl.classList.remove('text-red-600', 'text-green-600', 'text-indigo-600'); 
            
            if (type === 'error') titleEl.classList.add('text-red-600');
            else if (type === 'success') titleEl.classList.add('text-green-600');
            else titleEl.classList.add('text-indigo-600');

            modal.classList.remove('hidden');
        };

        const closeAlertBox = () => {
            document.getElementById('alert-modal').classList.add('hidden');
        };

        // --- CRUD/Data Functions (FIX 1: Add Patient Logic) ---

        /** Adds a new patient (writes to public path) */
        const addNewPatient = async (e) => {
            e.preventDefault();
            if (!['Admin', 'Nurse'].includes(currentUserRole)) {
                alertBox('Access Denied', 'Only Nurses or Admins can admit patients.', 'error');
                return;
            }

            const name = document.getElementById('patient-name').value;
            const dob = document.getElementById('patient-dob').value;
            const contact = document.getElementById('patient-contact').value;

            try {
                // FIX: Use PUBLIC collection for shared visibility
                await addDoc(getPublicCollectionRef('patients'), {
                    name,
                    dob,
                    contact,
                    admissionDate: new Date().toISOString(),
                    status: 'Admitted',
                    admittedBy: userId.substring(0, 8)
                });
                alertBox('Success', `Patient ${name} admitted successfully.`, 'success');
                closeAddPatientModal();
                document.getElementById('add-patient-form').reset();
            } catch (e) {
                console.error("Error adding patient:", e);
                alertBox('Error', 'Failed to admit patient. Check console for details.', 'error');
            }
        };

        /** Submits a consultation report (writes to public path) (FIX 2: Consultation Logic) */
        const submitConsultationReport = async (e) => {
            e.preventDefault();
            if (!['Admin', 'Nurse'].includes(currentUserRole)) {
                alertBox('Access Denied', 'You do not have permission to record consultations.', 'error');
                return;
            }

            const patientId = document.getElementById('consultation-patient-id').value;
            const patientName = document.getElementById('consultation-patient-name').value;
            const notes = document.getElementById('consultation-notes').value;
            const prescription = document.getElementById('consultation-prescription').value;

            try {
                // FIX: Use PUBLIC collection for shared visibility (Reports)
                await addDoc(getPublicCollectionRef('consultations'), {
                    patientId,
                    patientName,
                    notes,
                    prescription,
                    recordedBy: userId.substring(0, 8),
                    timestamp: new Date().toISOString(),
                    status: 'Completed'
                });
                alertBox('Success', `Consultation recorded for ${patientName}.`, 'success');
                closeConsultationModal();
                document.getElementById('consultation-form').reset();
            } catch (e) {
                console.error("Error recording consultation:", e);
                alertBox('Error', 'Failed to record consultation. Check console for details.', 'error');
            }
        };

        /** Updates the status of a patient */
        const updatePatientStatus = async (patientId, newStatus) => {
            if (!['Admin', 'Nurse'].includes(currentUserRole)) {
                alertBox('Access Denied', 'You do not have permission to update patient status.', 'error');
                return;
            }
            try {
                const docRef = doc(getPublicCollectionRef('patients'), patientId);
                await updateDoc(docRef, { status: newStatus });
                alertBox('Success', `Patient status updated to ${newStatus}.`, 'success');
            } catch (e) {
                console.error("Error updating patient status:", e);
                alertBox('Error', 'Failed to update patient status.', 'error');
            }
        };

        /** Updates inventory stock (Admin function) */
        const updateInventoryStock = async (itemId, change) => {
            if (currentUserRole !== 'Admin') {
                alertBox('Access Denied', 'Only Admins can update inventory.', 'error');
                return;
            }

            const itemRef = doc(getPublicCollectionRef('inventory'), itemId);

            try {
                await runTransaction(db, async (transaction) => {
                    const itemDoc = await transaction.get(itemRef);
                    if (!itemDoc.exists()) {
                        throw new Error("Item does not exist!");
                    }
                    const newStock = (itemDoc.data().stock || 0) + change;
                    if (newStock < 0) {
                         throw new Error("Stock cannot be negative.");
                    }
                    transaction.update(itemRef, { stock: newStock });
                });
                alertBox('Success', `Stock updated.`, 'success');
            } catch (e) {
                console.error("Error updating inventory:", e);
                alertBox('Error', `Failed to update inventory: ${e.message}`, 'error');
            }
        };

        // --- Real-time Listeners (FIX 3: Receiving Reports and Patient Updates) ---

        const setupRealtimeListeners = () => {
            // Patients Listener (Enables real-time patient list updates)
            onSnapshot(getPublicCollectionRef('patients'), (snapshot) => {
                patientsData = [];
                snapshot.forEach(doc => patientsData.push({ id: doc.id, ...doc.data() }));
                renderPatientList(patientsData);
                renderConsultationPatientDropdown(patientsData);
            }, (error) => console.error("Patients snapshot failed:", error));

            // Consultations Listener (Enables real-time report reception)
            onSnapshot(getPublicCollectionRef('consultations'), (snapshot) => {
                consultationsData = [];
                snapshot.forEach(doc => consultationsData.push({ id: doc.id, ...doc.data() }));
                renderConsultationReports(consultationsData);
            }, (error) => console.error("Consultations snapshot failed:", error));

            // Inventory Listener
            onSnapshot(getPublicCollectionRef('inventory'), (snapshot) => {
                inventoryData = [];
                snapshot.forEach(doc => inventoryData.push({ id: doc.id, ...doc.data() }));
                renderInventoryList(inventoryData);
            }, (error) => console.error("Inventory snapshot failed:", error));
        };

        // --- Seeding Functions (for Inventory) ---
        const checkAndSeedInventory = async () => {
            if (!isAuthReady || inventorySeeded) return; 
            const snapshot = await getDocs(getPublicCollectionRef('inventory'));

            if (snapshot.empty) {
                const initialItems = [
                    { name: 'Paracetamol', stock: 500, location: 'Pharmacy A' },
                    { name: 'IV Drip Solution', stock: 120, location: 'Storage 2' },
                    { name: 'Surgical Gloves (Box)', stock: 45, location: 'Storage 1' },
                    { name: 'Antibiotic X', stock: 80, location: 'Pharmacy B' },
                ];
                for (const item of initialItems) {
                    await addDoc(getPublicCollectionRef('inventory'), item);
                }
            }
            inventorySeeded = true;
        };

        // --- Rendering Functions ---

        const renderPatientList = (patients) => {
            const container = document.getElementById('patient-list-container');
            if (!container) return; // Prevent errors if container is missing
            container.innerHTML = '';
            
            if (patients.length === 0) {
                 container.innerHTML = '<p class="text-center text-gray-400 p-8">No patients currently admitted.</p>';
                 return;
            }

            patients.sort((a, b) => new Date(b.admissionDate) - new Date(a.admissionDate)).forEach(p => {
                const statusColor = p.status === 'Discharged' ? 'bg-green-100 text-green-700' : 
                                    p.status === 'Admitted' ? 'bg-yellow-100 text-yellow-700' : 'bg-red-100 text-red-700';
                
                const actionsHtml = ['Admin', 'Nurse'].includes(currentUserRole) ? `
                        <div class="mt-3 flex space-x-2">
                            <button onclick="updatePatientStatus('${p.id}', 'Discharged')" class="text-xs px-3 py-1 bg-green-500 text-white rounded-md hover:bg-green-600 transition shadow-md">Discharge</button>
                            <button onclick="updatePatientStatus('${p.id}', 'Critical')" class="text-xs px-3 py-1 bg-red-500 text-white rounded-md hover:bg-red-600 transition shadow-md">Critical</button>
                        </div>` : '';

                const patientCard = `
                    <div class="bg-white p-4 rounded-lg shadow-md border-l-4 border-indigo-500 mb-3 hover:shadow-lg transition">
                        <div class="flex justify-between items-start">
                            <p class="font-bold text-lg text-gray-800">${p.name}</p>
                            <span class="px-3 py-1 text-xs font-semibold rounded-full ${statusColor}">${p.status}</span>
                        </div>
                        <p class="text-sm text-gray-600 mt-1">DOB: ${p.dob} | Contact: ${p.contact}</p>
                        <p class="text-xs text-gray-500">Admitted: ${new Date(p.admissionDate).toLocaleDateString()} by ${p.admittedBy}</p>
                        ${actionsHtml}
                    </div>
                `;
                container.innerHTML += patientCard;
            });
        };

        const renderConsultationPatientDropdown = (patients) => {
            const dropdown = document.getElementById('patient-selector-dropdown');
            if (!dropdown) return; // Prevent errors
            dropdown.innerHTML = '<option value="">-- Select Patient --</option>';

            patients.forEach(p => {
                dropdown.innerHTML += `<option value="${p.id}" data-name="${p.name}">${p.name} (ID: ${p.id.substring(0, 5)})</option>`;
            });
        };

        const handlePatientSelection = () => {
            const dropdown = document.getElementById('patient-selector-dropdown');
            const selectedId = dropdown.value;
            const selectedOption = dropdown.options[dropdown.selectedIndex];
            
            document.getElementById('consultation-patient-id').value = selectedId;
            document.getElementById('consultation-patient-name').value = selectedOption.getAttribute('data-name') || '';
        };

        const renderConsultationReports = (consultations) => {
            const container = document.getElementById('consultation-reports-container');
            if (!container) return; // Prevent errors
            container.innerHTML = '';

            if (consultations.length === 0) {
                 container.innerHTML = '<p class="text-center text-gray-400 p-8">No consultation reports recorded yet.</p>';
                 return;
            }
            
            consultations.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp)).forEach(c => {
                const reportCard = `
                    <div class="bg-white p-4 rounded-lg shadow-md border-l-4 border-green-500 mb-3">
                        <div class="flex justify-between items-center">
                            <p class="font-bold text-md text-gray-800">Patient: ${c.patientName}</p>
                            <span class="text-xs text-gray-500">ID: ${c.patientId.substring(0, 5)}</span>
                        </div>
                        <h4 class="font-semibold text-sm mt-2 text-indigo-700">Notes:</h4>
                        <p class="text-sm text-gray-700">${c.notes}</p>
                        <h4 class="font-semibold text-sm mt-2 text-indigo-700">Prescription:</h4>
                        <p class="text-sm text-gray-700">${c.prescription || 'N/A'}</p>
                        <p class="text-xs text-gray-500 mt-3 border-t pt-2">Recorded by ${c.recordedBy} on ${new Date(c.timestamp).toLocaleString()}</p>
                    </div>
                `;
                container.innerHTML += reportCard;
            });
        };

        const renderInventoryList = (items) => {
            const container = document.getElementById('inventory-list-container');
            if (!container) return; // Prevent errors
            container.innerHTML = '';
            
            const isAdmin = currentUserRole === 'Admin';

            if (items.length === 0) {
                 container.innerHTML = '<p class="text-center text-gray-400 p-8">Inventory is empty. Admins can reload to seed items.</p>';
                 return;
            }

            items.sort((a, b) => a.name.localeCompare(b.name)).forEach(item => {
                const isLowStock = item.stock < 10;
                const stockColor = isLowStock ? 'text-red-600 font-bold' : 'text-green-600';
                
                const actionsHtml = isAdmin ? `
                    <div class="w-1/4 flex justify-end space-x-2">
                        <button onclick="updateInventoryStock('${item.id}', 10)" class="text-xs px-2 py-1 bg-indigo-500 text-white rounded-md hover:bg-indigo-600 shadow-md">+</button>
                        <button onclick="updateInventoryStock('${item.id}', -1)" class="text-xs px-2 py-1 bg-red-500 text-white rounded-md hover:bg-red-600 shadow-md">-</button>
                    </div>` : `<p class="w-1/4 text-center text-gray-400">View Only</p>`;

                const itemRow = `
                    <div class="flex items-center p-3 border-b border-gray-100 hover:bg-gray-50 ${isLowStock ? 'low-stock bg-red-50 border-red-300' : ''}">
                        <p class="font-medium w-2/5 text-gray-800">${item.name}</p>
                        <p class="w-1/5 text-center text-gray-600">${item.location}</p>
                        <p class="w-1/5 text-center ${stockColor}">Stock: ${item.stock}</p>
                        ${actionsHtml}
                    </div>
                `;
                container.innerHTML += itemRow;
            });
        };


        // --- UI State Toggles ---

        const showAddPatientModal = () => document.getElementById('add-patient-modal')?.classList.remove('hidden');
        const closeAddPatientModal = () => document.getElementById('add-patient-modal')?.classList.add('hidden');
        
        const showConsultationModal = () => document.getElementById('consultation-modal')?.classList.remove('hidden');
        const closeConsultationModal = () => document.getElementById('consultation-modal')?.classList.add('hidden');

        // --- Core Initialization ---

        const initializeDashboard = async (uid) => {
            console.log(`Dashboard initializing for UID: ${uid}`);
            
            currentUserRole = await fetchUserRole(uid);
            document.getElementById('current-role').textContent = `Role: ${currentUserRole}`;
            document.getElementById('current-uid').textContent = `UID: ${uid.substring(0, 15)}...`;

            // Setup listeners and initial data fetch
            setupRealtimeListeners(); 
            // Only admins should seed the data if it's empty
            checkAndSeedInventory(); 
        };
        
        const initFirebase = async () => {
            appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
            const statusElement = document.getElementById('db-status');
            if (!statusElement) return;

            statusElement.textContent = "Status: Connecting...";

            let firebaseConfig = null;
            try {
                if (typeof __firebase_config !== 'undefined' && __firebase_config) {
                    firebaseConfig = JSON.parse(__firebase_config);
                }
            } catch (e) {
                console.error("CRITICAL ERROR: Failed to parse Firebase config.", e);
            }

            if (!firebaseConfig) {
                statusElement.textContent = "ERROR: Config Missing.";
                statusElement.classList.add('text-red-600');
                return;
            }
            
            try {
                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                setLogLevel('error'); // Keep console clean unless there's an issue
            } catch(e) {
                console.error("ERROR: Failed to initialize Firebase App.", e);
                statusElement.textContent = "ERROR: SDK Failed.";
                statusElement.classList.add('text-red-600');
                return;
            }

            // Auth State Listener
            onAuthStateChanged(auth, async (user) => {
                if (user) {
                    if (isAuthReady) return; 
                    
                    userId = user.uid;
                    isAuthReady = true;

                    await initializeDashboard(user.uid);

                    statusElement.textContent = "Status: Connected";
                    statusElement.classList.remove('text-red-600');
                    statusElement.classList.add('text-green-600');

                } else {
                    console.log("User logged out or not authenticated.");
                    statusElement.textContent = "Status: Logged Out";
                    statusElement.classList.add('text-red-600');
                }
            });

            // Initial sign-in attempt (using token or anonymously)
            try {
                const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    await signInAnonymously(auth);
                }
            } catch (e) {
                console.error("Initial authentication failed, attempting anonymous fallback:", e);
                await signInAnonymously(auth);
            }
        };

        const handleSignOut = async () => {
            try {
                await signOut(auth);
                alertBox('Logged Out', 'You have been successfully signed out.', 'info');
            } catch (error) {
                console.error("Error signing out:", error);
                alertBox('Error', 'Failed to sign out. Check console for details.', 'error');
            }
        }
        
        // --- Event Handlers Setup ---
        window.onload = initFirebase;
        
        // Expose functions globally for inline HTML event handlers
        window.addNewPatient = addNewPatient; // EXPOSED: Fixes Add Patient
        window.submitConsultationReport = submitConsultationReport; // EXPOSED: Fixes Submit Report
        window.updatePatientStatus = updatePatientStatus;
        window.updateInventoryStock = updateInventoryStock;
        window.showAddPatientModal = showAddPatientModal;
        window.closeAddPatientModal = closeAddPatientModal;
        window.showConsultationModal = showConsultationModal;
        window.closeConsultationModal = closeConsultationModal;
        window.alertBox = alertBox;
        window.closeAlertBox = closeAlertBox;
        window.handlePatientSelection = handlePatientSelection;
        window.handleSignOut = handleSignOut;

        // Listen for form submissions (ensures forms call the new functions)
        document.addEventListener('DOMContentLoaded', () => {
            document.getElementById('add-patient-form')?.addEventListener('submit', addNewPatient);
            document.getElementById('consultation-form')?.addEventListener('submit', submitConsultationReport);
        });

    </script>
    
    <!-- NOTE: The rest of the HTML body content is assumed to be below this line -->

    <!-- Header -->
    <header class="bg-indigo-700 text-white shadow-lg p-4 flex justify-between items-center z-20">
        <div class="flex items-center space-x-3">
            <svg class="w-8 h-8 text-indigo-300" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path></svg>
            <h1 class="text-2xl font-extrabold tracking-tight">Clinic Operations Hub</h1>
        </div>
        <div class="flex items-center space-x-4 text-sm">
            <span id="current-role" class="px-3 py-1 bg-indigo-500 rounded-full font-semibold">Role: Loading...</span>
            <span id="current-uid" class="text-indigo-200 hidden md:inline-block">UID: Loading...</span>
            <button onclick="handleSignOut()" class="flex items-center bg-indigo-600 hover:bg-indigo-500 px-3 py-1 rounded-lg transition duration-150">
                <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"></path></svg>
                Sign Out
            </button>
        </div>
    </header>

    <!-- Main Content Area -->
    <main class="flex-grow p-6">
        <div class="max-w-7xl mx-auto">
            <div class="text-xs mb-4">
                <span id="db-status" class="font-mono text-gray-500">Initializing database...</span>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">

                <!-- 1. Patient Management Card -->
                <div class="lg:col-span-2 dashboard-card p-6 rounded-2xl shadow-xl">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-2xl font-bold text-indigo-700">Patient Registry</h2>
                        <button onclick="showAddPatientModal()" class="bg-green-500 text-white px-4 py-2 rounded-full font-semibold hover:bg-green-600 transition shadow-md flex items-center">
                            <svg class="w-5 h-5 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v3m0 0v3m0-3h3m-3 0H9m12 0a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                            Admit New Patient
                        </button>
                    </div>

                    <div id="patient-list-container" class="scrollable-list p-2">
                        <!-- Patient Cards will be rendered here -->
                        <p class="text-center text-gray-400 p-8">Loading patient data...</p>
                    </div>
                </div>

                <!-- 2. Consultation Report Card -->
                <div class="dashboard-card p-6 rounded-2xl shadow-xl">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-2xl font-bold text-indigo-700">Consultation Reports</h2>
                        <button onclick="showConsultationModal()" class="bg-yellow-500 text-white px-4 py-2 rounded-full font-semibold hover:bg-yellow-600 transition shadow-md flex items-center">
                            <svg class="w-5 h-5 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2m-9 0V3h4v2m-4 0v2h4V5m-4 0h4m-4 4h4m-4 4h4m-4 4h4"></path></svg>
                            New Report
                        </button>
                    </div>
                    
                    <div id="consultation-reports-container" class="scrollable-list pr-2">
                        <!-- Consultation reports rendered here -->
                        <p class="text-center text-gray-400 p-8">Waiting for reports...</p>
                    </div>
                </div>

                <!-- 3. Inventory Card (Full Width) -->
                <div class="lg:col-span-3 dashboard-card p-6 rounded-2xl shadow-xl mt-6">
                    <h2 class="text-2xl font-bold text-indigo-700 mb-4">Inventory Management</h2>
                    
                    <div class="bg-gray-50 rounded-lg overflow-hidden border border-gray-200">
                        <div class="sticky-header flex items-center font-bold text-gray-700 bg-gray-100 p-3 border-b border-gray-200">
                            <p class="w-2/5">Item</p>
                            <p class="w-1/5 text-center">Location</p>
                            <p class="w-1/5 text-center">Stock Level</p>
                            <p class="w-1/4 text-right">Actions (Admin Only)</p>
                        </div>
                        <div id="inventory-list-container">
                            <!-- Inventory list rendered here -->
                            <p class="text-center text-gray-400 p-8">Loading inventory...</p>
                        </div>
                    </div>
                </div>

            </div>
        </div>
    </main>

    <!-- MODAL: Add Patient -->
    <div id="add-patient-modal" class="fixed inset-0 modal-backdrop hidden flex items-center justify-center z-50 p-4">
        <div class="bg-white p-6 rounded-xl shadow-2xl w-full max-w-lg transform transition-all duration-300">
            <h3 class="text-2xl font-bold text-indigo-700 mb-4 border-b pb-2">Admit New Patient</h3>
            <form id="add-patient-form" class="space-y-4">
                <input type="text" id="patient-name" placeholder="Full Name" required class="w-full p-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 shadow-sm">
                <input type="date" id="patient-dob" placeholder="Date of Birth" required class="w-full p-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 shadow-sm">
                <input type="text" id="patient-contact" placeholder="Contact/Phone" required class="w-full p-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 shadow-sm">
                <div class="flex justify-end space-x-3 pt-2">
                    <button type="button" onclick="closeAddPatientModal()" class="px-4 py-2 border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-100 transition">Cancel</button>
                    <button type="submit" class="px-4 py-2 bg-green-500 text-white rounded-lg font-semibold hover:bg-green-600 transition shadow-md">Admit Patient</button>
                </div>
            </form>
        </div>
    </div>

    <!-- MODAL: Add Consultation Report -->
    <div id="consultation-modal" class="fixed inset-0 modal-backdrop hidden flex items-center justify-center z-50 p-4">
        <div class="bg-white p-6 rounded-xl shadow-2xl w-full max-w-2xl transform transition-all duration-300">
            <h3 class="text-2xl font-bold text-indigo-700 mb-4 border-b pb-2">Record Consultation Report</h3>
            <form id="consultation-form" class="space-y-4">
                <!-- Patient Selector -->
                <select id="patient-selector-dropdown" onchange="handlePatientSelection()" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 shadow-sm" required>
                    <option value="">-- Select Patient --</option>
                    <!-- Options populated by JS -->
                </select>
                <!-- Hidden inputs to hold selected data -->
                <input type="hidden" id="consultation-patient-id" required>
                <input type="hidden" id="consultation-patient-name" required>

                <textarea id="consultation-notes" placeholder="Detailed Examination Notes & Diagnosis" rows="5" required class="w-full p-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 shadow-sm"></textarea>
                <textarea id="consultation-prescription" placeholder="Prescriptions / Treatment Plan" rows="3" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 shadow-sm"></textarea>

                <div class="flex justify-end space-x-3 pt-2">
                    <button type="button" onclick="closeConsultationModal()" class="px-4 py-2 border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-100 transition">Cancel</button>
                    <button type="submit" class="px-4 py-2 bg-yellow-500 text-white rounded-lg font-semibold hover:bg-yellow-600 transition shadow-md">Submit Report</button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- MODAL: Custom Alert Box (Replaces window.alert) -->
    <div id="alert-modal" class="fixed inset-0 modal-backdrop hidden flex items-center justify-center z-50 p-4">
        <div class="bg-white p-6 rounded-xl shadow-2xl w-full max-w-sm transform transition-all duration-300 scale-100">
            <h3 id="alert-title" class="text-xl font-bold mb-2"></h3>
            <p id="alert-message" class="text-gray-700 mb-4"></p>
            <button onclick="closeAlertBox()" class="w-full bg-indigo-600 text-white py-2 rounded-lg hover:bg-indigo-700 font-medium transition duration-150 shadow-md">OK</button>
        </div>
    </div>
</body>
</html>
