<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Clinic Dashboard</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Inter Font -->
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        body { font-family: 'Inter', sans-serif; background-color: #f4f7f9; }
        .dashboard-card {
            background-color: #ffffff;
            border: 1px solid #e0e7ff; /* Indigo 100 */
            transition: all 0.2s ease-in-out;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05), 0 2px 4px -2px rgba(0, 0, 0, 0.05);
        }
        /* Style for the sticky header in task lists */
        .sticky-header {
            position: sticky;
            top: 0;
            z-index: 10;
        }
        /* Modal Backdrop */
        .modal-backdrop {
            background-color: rgba(0, 0, 0, 0.6);
        }
    </style>
</head>
<body class="min-h-screen flex flex-col">

    <!-- Header -->
    <header class="bg-indigo-700 text-white shadow-lg p-4 flex justify-between items-center z-20">
        <div class="flex items-center space-x-3">
            <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z"></path></svg>
            <span class="text-2xl font-bold tracking-tight">Clinic Dashboard</span>
        </div>
        <div class="flex items-center space-x-4">
            <span id="user-display" class="text-sm font-medium">Loading User...</span>
            <button id="logout-button" class="bg-white text-indigo-700 font-semibold py-1 px-3 rounded-lg shadow hover:bg-indigo-100 transition duration-150">Logout</button>
        </div>
    </header>

    <!-- Main Content Area -->
    <main class="flex-grow p-6 lg:p-10">
        <div id="loading-indicator" class="text-center text-indigo-600 font-semibold my-8">
            <svg class="animate-spin h-8 w-8 text-indigo-600 mx-auto" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
            <p class="mt-2">Loading data and authenticating...</p>
        </div>
        
        <div id="content-area" class="hidden">
            <!-- Stats Grid -->
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-10">
                <div class="dashboard-card p-5 rounded-xl">
                    <h3 class="text-lg font-semibold text-gray-500 mb-1">Total Patients</h3>
                    <p id="stat-patients" class="text-3xl font-bold text-indigo-600">0</p>
                </div>
                <div class="dashboard-card p-5 rounded-xl">
                    <h3 class="text-lg font-semibold text-gray-500 mb-1">Pending Check-ups</h3>
                    <p id="stat-pending" class="text-3xl font-bold text-red-500">0</p>
                </div>
                <div class="dashboard-card p-5 rounded-xl">
                    <h3 class="text-lg font-semibold text-gray-500 mb-1">Stock Level</h3>
                    <p id="stat-stock" class="text-3xl font-bold text-green-600">N/A</p>
                </div>
                <div class="dashboard-card p-5 rounded-xl">
                    <h3 class="text-lg font-semibold text-gray-500 mb-1">Clinic Role</h3>
                    <p id="stat-role" class="text-3xl font-bold text-purple-600 capitalize">N/A</p>
                </div>
            </div>

            <!-- Dashboard Sections -->
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                <!-- Patient List (2/3 width) -->
                <div class="lg:col-span-2">
                    <div class="dashboard-card p-6 rounded-xl h-full">
                        <div class="flex justify-between items-center mb-4">
                            <h2 class="text-xl font-bold text-gray-800">Patient Directory</h2>
                            <button onclick="showAddPatientModal()" class="bg-indigo-600 hover:bg-indigo-700 text-white font-medium py-2 px-4 rounded-lg shadow-md transition duration-150 flex items-center">
                                <svg class="w-5 h-5 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path></svg>
                                Add Patient
                            </button>
                        </div>
                        <div class="overflow-x-auto">
                            <table class="min-w-full divide-y divide-gray-200">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Name</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ID</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Added By</th>
                                        <th class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="patients-list" class="bg-white divide-y divide-gray-200">
                                    <!-- Patient rows will be injected here -->
                                    <tr><td colspan="5" class="text-center py-4 text-gray-500">No patients found.</td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Global Tasks (1/3 width) -->
                <div class="lg:col-span-1">
                    <div class="dashboard-card p-6 rounded-xl h-full flex flex-col">
                        <h2 class="text-xl font-bold text-gray-800 mb-4">Global Tasks</h2>
                        <div id="tasks-list" class="space-y-3 flex-grow overflow-y-auto">
                            <p class="text-gray-500">No global tasks.</p>
                        </div>
                        <div class="mt-4">
                            <input type="text" id="new-task-input" placeholder="Add a new task..." class="w-full border-gray-300 rounded-lg shadow-sm focus:ring-indigo-500 focus:border-indigo-500 text-sm p-2">
                            <button onclick="addGlobalTask()" class="mt-2 w-full bg-indigo-500 hover:bg-indigo-600 text-white font-medium py-2 rounded-lg transition duration-150">Add Task</button>
                        </div>
                    </div>
                </div>

                <!-- Consultation Reports (Full width below) -->
                <div class="lg:col-span-3 mt-6">
                    <div class="dashboard-card p-6 rounded-xl">
                        <div class="flex justify-between items-center mb-4">
                            <h2 class="text-xl font-bold text-gray-800">Consultation Reports</h2>
                            <button onclick="showConsultationModal()" class="bg-green-600 hover:bg-green-700 text-white font-medium py-2 px-4 rounded-lg shadow-md transition duration-150 flex items-center">
                                <svg class="w-5 h-5 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-3-3v6m-4-19h14a2 2 0 012 2v14a2 2 0 01-2 2H5a2 2 0 01-2-2V5a2 2 0 012-2z"></path></svg>
                                Add Report
                            </button>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4" id="consultation-reports-list">
                            <p class="text-gray-500 col-span-full">No consultation reports available.</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>
    
    <!-- Modals (Add Patient & Consultation) -->
    
    <!-- Add Patient Modal -->
    <div id="add-patient-modal" class="hidden modal-backdrop fixed inset-0 flex items-center justify-center p-4 z-50">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-lg p-6 transform transition-all duration-300 scale-100">
            <h3 class="text-2xl font-bold text-indigo-700 mb-4">Add New Patient</h3>
            <form id="add-patient-form">
                <div class="mb-4">
                    <label for="patient-name" class="block text-sm font-medium text-gray-700">Patient Name</label>
                    <input type="text" id="patient-name" required class="mt-1 block w-full border border-gray-300 rounded-lg shadow-sm p-2 focus:ring-indigo-500 focus:border-indigo-500">
                </div>
                <div class="mb-4">
                    <label for="patient-id" class="block text-sm font-medium text-gray-700">Patient ID (Unique)</label>
                    <input type="text" id="patient-id" required class="mt-1 block w-full border border-gray-300 rounded-lg shadow-sm p-2 focus:ring-indigo-500 focus:border-indigo-500">
                </div>
                <div class="flex justify-end space-x-3">
                    <button type="button" onclick="closeAddPatientModal()" class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-medium py-2 px-4 rounded-lg transition duration-150">Cancel</button>
                    <button type="submit" class="bg-indigo-600 hover:bg-indigo-700 text-white font-medium py-2 px-4 rounded-lg transition duration-150">Save Patient</button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- Consultation Report Modal -->
    <div id="consultation-modal" class="hidden modal-backdrop fixed inset-0 flex items-center justify-center p-4 z-50">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-2xl p-6 transform transition-all duration-300 scale-100">
            <h3 class="text-2xl font-bold text-green-700 mb-4">New Consultation Report</h3>
            <form id="consultation-form">
                <div class="mb-4">
                    <label for="consultation-patient-id" class="block text-sm font-medium text-gray-700">Patient ID</label>
                    <input type="text" id="consultation-patient-id" required class="mt-1 block w-full border border-gray-300 rounded-lg shadow-sm p-2 focus:ring-green-500 focus:border-green-500">
                </div>
                <div class="mb-4">
                    <label for="consultation-summary" class="block text-sm font-medium text-gray-700">Consultation Summary</label>
                    <textarea id="consultation-summary" rows="4" required class="mt-1 block w-full border border-gray-300 rounded-lg shadow-sm p-2 focus:ring-green-500 focus:border-green-500"></textarea>
                </div>
                <div class="flex justify-end space-x-3">
                    <button type="button" onclick="closeConsultationModal()" class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-medium py-2 px-4 rounded-lg transition duration-150">Cancel</button>
                    <button type="submit" class="bg-green-600 hover:bg-green-700 text-white font-medium py-2 px-4 rounded-lg transition duration-150">Submit Report</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Universal Alert/Message Box -->
    <div id="alert-box" class="fixed top-4 right-4 z-50 transform transition-transform duration-300 translate-x-full">
        <div id="alert-content" class="bg-indigo-600 text-white p-4 rounded-xl shadow-lg flex items-center space-x-3">
            <svg id="alert-icon" class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg>
            <p id="alert-message" class="font-medium"></p>
        </div>
    </div>
    
    <!-- Edit Patient Modal (New: For the nurse/admin to modify patient data) -->
    <div id="edit-patient-modal" class="hidden modal-backdrop fixed inset-0 flex items-center justify-center p-4 z-50">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-lg p-6 transform transition-all duration-300 scale-100">
            <h3 class="text-2xl font-bold text-yellow-700 mb-4">Edit Patient Details</h3>
            <form id="edit-patient-form">
                <input type="hidden" id="edit-patient-doc-id">
                <div class="mb-4">
                    <label for="edit-patient-name" class="block text-sm font-medium text-gray-700">Patient Name</label>
                    <input type="text" id="edit-patient-name" required class="mt-1 block w-full border border-gray-300 rounded-lg shadow-sm p-2 focus:ring-yellow-500 focus:border-yellow-500">
                </div>
                <div class="mb-4">
                    <label for="edit-patient-id" class="block text-sm font-medium text-gray-700">Patient ID</label>
                    <input type="text" id="edit-patient-id" required disabled class="mt-1 block w-full bg-gray-100 border border-gray-300 rounded-lg shadow-sm p-2">
                </div>
                <div class="flex justify-end space-x-3">
                    <button type="button" onclick="closeEditPatientModal()" class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-medium py-2 px-4 rounded-lg transition duration-150">Cancel</button>
                    <button type="submit" class="bg-yellow-600 hover:bg-yellow-700 text-white font-medium py-2 px-4 rounded-lg transition duration-150">Save Changes</button>
                </div>
            </form>
        </div>
    </div>


    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, updateDoc, deleteDoc, onSnapshot, collection, query, where, addDoc, getDocs, runTransaction, arrayRemove, arrayUnion, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Global variables provided by the environment
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : null;
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        let db;
        let auth;
        let currentUser = null; // Stores the Firebase User object
        let currentUserId = null; // Stores the UID
        let userRole = null; // Stores the user's assigned role ('admin' or 'nurse')
        const USER_ROLES_COLLECTION = 'user_roles';
        const PATIENTS_COLLECTION = 'patients';
        const REPORTS_COLLECTION = 'consultation_reports';
        const TASKS_COLLECTION = 'global_tasks';
        
        // --- Utility Functions ---

        /** Constructs the Firestore path for a collection, respecting security rules. */
        function getCollectionPath(collectionName) {
            // All data is public for viewing by all authenticated users
            return `/artifacts/${appId}/public/data/${collectionName}`;
        }
        
        /** Shows the custom alert box. */
        function alertBox(message, type = 'success') {
            const alertEl = document.getElementById('alert-box');
            const messageEl = document.getElementById('alert-message');
            const iconEl = document.getElementById('alert-icon');

            messageEl.textContent = message;
            alertEl.className = 'fixed top-4 right-4 z-50 transform transition-transform duration-300 translate-x-full'; // Reset
            
            // Set styles and icon
            let bgColor = 'bg-indigo-600';
            let iconPath = '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>'; // Checkmark
            
            if (type === 'error') {
                bgColor = 'bg-red-600';
                iconPath = '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>'; // X
            } else if (type === 'warning') {
                bgColor = 'bg-yellow-600';
                iconPath = '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.332 16c-.77 1.333.192 3 1.732 3z"></path>'; // Warning triangle
            }

            iconEl.innerHTML = iconPath;
            alertEl.firstElementChild.className = `${bgColor} text-white p-4 rounded-xl shadow-lg flex items-center space-x-3`;

            // Animate in
            setTimeout(() => {
                alertEl.classList.remove('translate-x-full');
                alertEl.classList.add('translate-x-0');
            }, 100);

            // Animate out
            setTimeout(() => {
                alertEl.classList.remove('translate-x-0');
                alertEl.classList.add('translate-x-full');
            }, 5000);
        }

        // --- Auth & Role Management ---

        function checkAuthAndRedirect() {
            // Check for existence of the token in URL before init
            if (!initialAuthToken && !window.location.href.includes('index.html')) {
                // Not authenticated and not on login page, redirect to login
                window.location.href = 'index.html';
            }
        }
        
        async function fetchUserRole(uid) {
            if (!db) return 'nurse'; // Default to nurse if DB not ready
            const roleDocRef = doc(db, getCollectionPath(USER_ROLES_COLLECTION), uid);
            try {
                const docSnap = await getDoc(roleDocRef);
                return docSnap.exists() ? docSnap.data().role : 'nurse'; // Default new users to 'nurse'
            } catch (error) {
                console.error("Error fetching user role:", error);
                return 'nurse';
            }
        }

        async function initFirebase() {
            if (!firebaseConfig) {
                console.error("Firebase config is missing.");
                document.getElementById('loading-indicator').innerHTML = '<p class="text-red-500 font-bold">Error: Firebase configuration is missing.</p>';
                return;
            }

            try {
                // Enable debug logging for Firestore
                setLogLevel('debug');
                
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);

                // 1. Initial Authentication
                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    await signInAnonymously(auth);
                }

                // 2. Auth State Listener
                onAuthStateChanged(auth, async (user) => {
                    currentUser = user;
                    
                    if (user) {
                        currentUserId = user.uid;
                        // Fetch the user's role
                        userRole = await fetchUserRole(user.uid);
                        
                        // Update UI and show content
                        document.getElementById('user-display').textContent = `User ID: ${user.uid.substring(0, 8)}... (${userRole.toUpperCase()})`;
                        document.getElementById('stat-role').textContent = userRole.toUpperCase();
                        document.title = `Clinic Dashboard - ${userRole.toUpperCase()}`;
                        document.getElementById('loading-indicator').classList.add('hidden');
                        document.getElementById('content-area').classList.remove('hidden');

                        // Start real-time listeners only after auth is confirmed
                        startListeners();

                    } else {
                        // User logged out or failed authentication
                        window.location.href = 'index.html';
                    }
                });
                
                // Logout Handler
                document.getElementById('logout-button').onclick = async () => {
                    try {
                        await signOut(auth);
                    } catch (e) {
                        console.error("Logout failed:", e);
                        alertBox("Logout failed.", 'error');
                    }
                };

            } catch (e) {
                console.error("Firebase initialization failed:", e);
                document.getElementById('loading-indicator').innerHTML = `<p class="text-red-500 font-bold">Initialization Error: ${e.message}</p>`;
            }
        }

        // --- Real-time Listeners ---

        function startListeners() {
            if (!db || !currentUserId) {
                console.error("Database or User ID not available to start listeners.");
                return;
            }
            
            // Listen for Patient updates
            const patientsRef = collection(db, getCollectionPath(PATIENTS_COLLECTION));
            onSnapshot(patientsRef, (snapshot) => {
                const patients = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderPatients(patients);
                // Update stats
                document.getElementById('stat-patients').textContent = patients.length;
                document.getElementById('stat-pending').textContent = patients.filter(p => p.status === 'Pending').length;
            }, (error) => {
                console.error("Error listening to patients:", error);
            });

            // Listen for Global Task updates
            const tasksRef = collection(db, getCollectionPath(TASKS_COLLECTION));
            onSnapshot(tasksRef, (snapshot) => {
                const tasks = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderGlobalTasks(tasks);
            }, (error) => {
                console.error("Error listening to global tasks:", error);
            });
            
            // Listen for Consultation Reports
            const reportsRef = collection(db, getCollectionPath(REPORTS_COLLECTION));
            onSnapshot(reportsRef, (snapshot) => {
                const reports = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderConsultationReports(reports);
            }, (error) => {
                console.error("Error listening to reports:", error);
            });
            
        }
        
        // --- Patient Management Functions ---
        
        function showAddPatientModal() {
            document.getElementById('add-patient-modal').classList.remove('hidden');
        }

        function closeAddPatientModal() {
            document.getElementById('add-patient-modal').classList.add('hidden');
            document.getElementById('add-patient-form').reset();
        }

        function showEditPatientModal(patient) {
            document.getElementById('edit-patient-doc-id').value = patient.id;
            document.getElementById('edit-patient-name').value = patient.name;
            document.getElementById('edit-patient-id').value = patient.patientId;
            document.getElementById('edit-patient-modal').classList.remove('hidden');
        }

        function closeEditPatientModal() {
            document.getElementById('edit-patient-modal').classList.add('hidden');
            document.getElementById('edit-patient-form').reset();
        }

        async function addNewPatient(event) {
            event.preventDefault();
            
            if (!currentUserId || !userRole) {
                alertBox("Authentication failed. Please log in again.", 'error');
                return;
            }

            const name = document.getElementById('patient-name').value.trim();
            const patientId = document.getElementById('patient-id').value.trim();
            
            if (!name || !patientId) {
                alertBox("Please fill out all patient fields.", 'error');
                return;
            }
            
            try {
                const patientsRef = collection(db, getCollectionPath(PATIENTS_COLLECTION));
                
                // Add new fields to enforce editing rules
                await addDoc(patientsRef, {
                    name: name,
                    patientId: patientId,
                    status: 'Pending', // Default status
                    createdAt: new Date().toISOString(),
                    createdByUserId: currentUserId, // Store the creator's UID
                    createdByRole: userRole,     // Store the creator's Role
                });

                alertBox(`Patient ${name} added successfully!`, 'success');
                closeAddPatientModal();
            } catch (e) {
                console.error("Error adding patient:", e);
                alertBox(`Error adding patient: ${e.message}`, 'error');
            }
        }
        
        async function updatePatientDetails(event) {
            event.preventDefault();

            if (!currentUserId || !userRole) {
                alertBox("Authentication failed. Please log in again.", 'error');
                return;
            }

            const docId = document.getElementById('edit-patient-doc-id').value;
            const newName = document.getElementById('edit-patient-name').value.trim();

            if (!docId || !newName) {
                alertBox("Missing patient details for update.", 'error');
                return;
            }

            try {
                const patientRef = doc(db, getCollectionPath(PATIENTS_COLLECTION), docId);
                
                // Fetch existing data to check permissions (frontend check for safety/UX)
                const docSnap = await getDoc(patientRef);
                if (!docSnap.exists()) {
                    alertBox("Patient not found.", 'error');
                    return;
                }

                const patientData = docSnap.data();
                
                // Frontend Edit Permission Check: Admin OR Creator
                const canEdit = userRole === 'admin' || patientData.createdByUserId === currentUserId;

                if (!canEdit) {
                     alertBox("You do not have permission to edit this patient.", 'error');
                     closeEditPatientModal();
                     return;
                }

                await updateDoc(patientRef, {
                    name: newName,
                    updatedAt: new Date().toISOString()
                });

                alertBox(`Patient ${newName} updated successfully.`, 'success');
                closeEditPatientModal();

            } catch (e) {
                console.error("Error updating patient:", e);
                alertBox(`Error updating patient: ${e.message}`, 'error');
            }
        }

        async function updatePatientStatus(docId, newStatus) {
            if (!docId || !newStatus) return;
            
            // Status changes are generally allowed for all Nurses/Admins who see the list, 
            // but we'll still use runTransaction for safety if multiple users interact.
            try {
                const patientRef = doc(db, getCollectionPath(PATIENTS_COLLECTION), docId);
                await updateDoc(patientRef, {
                    status: newStatus,
                    statusChangedAt: new Date().toISOString()
                });
                alertBox(`Patient status changed to ${newStatus}.`, 'success');
            } catch (e) {
                console.error("Error updating patient status:", e);
                alertBox("Failed to update status.", 'error');
            }
        }


        function renderPatients(patients) {
            const listEl = document.getElementById('patients-list');
            listEl.innerHTML = ''; // Clear existing list

            if (patients.length === 0) {
                listEl.innerHTML = '<tr><td colspan="5" class="text-center py-4 text-gray-500">No patients found.</td></tr>';
                return;
            }

            patients.forEach(patient => {
                // Determine if the current user has EDIT permission
                const canEdit = userRole === 'admin' || patient.createdByUserId === currentUserId;
                
                // Determine status badge color
                let statusClass = 'bg-gray-200 text-gray-800';
                if (patient.status === 'Pending') statusClass = 'bg-red-100 text-red-700';
                if (patient.status === 'Checked-in') statusClass = 'bg-yellow-100 text-yellow-700';
                if (patient.status === 'Discharged') statusClass = 'bg-green-100 text-green-700';

                const row = document.createElement('tr');
                row.className = 'hover:bg-indigo-50 transition duration-100';
                
                row.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${patient.name}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${patient.patientId}</td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <span class="px-3 py-1 inline-flex text-xs leading-5 font-semibold rounded-full ${statusClass}">
                            ${patient.status}
                        </span>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                        ${patient.createdByRole.toUpperCase()} (ID: ${patient.createdByUserId ? patient.createdByUserId.substring(0, 4) : 'N/A'})...
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-center space-x-2">
                        <!-- Status Dropdown (Available to all for general workflow) -->
                        <select onchange="updatePatientStatus('${patient.id}', this.value)" 
                                class="border border-gray-300 rounded-lg shadow-sm p-1 text-xs focus:ring-indigo-500 focus:border-indigo-500">
                            <option value="Pending" ${patient.status === 'Pending' ? 'selected' : ''}>Pending</option>
                            <option value="Checked-in" ${patient.status === 'Checked-in' ? 'selected' : ''}>Checked-in</option>
                            <option value="Discharged" ${patient.status === 'Discharged' ? 'selected' : ''}>Discharged</option>
                        </select>
                        
                        <!-- Edit Button (Conditional based on permission) -->
                        ${canEdit ? `
                            <button onclick="showEditPatientModal(${JSON.stringify(patient).replace(/"/g, '&quot;')})"
                                class="text-yellow-600 hover:text-yellow-900 ml-2 font-medium py-1 px-2 rounded-lg border border-yellow-300 hover:bg-yellow-50 transition duration-150 text-xs">
                                Edit
                            </button>
                        ` : ''}
                    </td>
                `;
                listEl.appendChild(row);
            });
        }
        
        // --- Consultation Reports Functions (Simplified for this update) ---

        function showConsultationModal() {
            document.getElementById('consultation-modal').classList.remove('hidden');
        }

        function closeConsultationModal() {
            document.getElementById('consultation-modal').classList.add('hidden');
            document.getElementById('consultation-form').reset();
        }

        async function submitConsultationReport(event) {
            event.preventDefault();
            
            if (!currentUserId) {
                alertBox("Authentication failed.", 'error');
                return;
            }

            const patientId = document.getElementById('consultation-patient-id').value.trim();
            const summary = document.getElementById('consultation-summary').value.trim();
            
            if (!patientId || !summary) {
                alertBox("Please fill out all report fields.", 'error');
                return;
            }

            try {
                const reportsRef = collection(db, getCollectionPath(REPORTS_COLLECTION));
                await addDoc(reportsRef, {
                    patientId: patientId,
                    summary: summary,
                    reportedBy: currentUserId,
                    reportedAt: new Date().toISOString()
                });

                alertBox(`Report for Patient ID ${patientId} submitted.`, 'success');
                closeConsultationModal();
            } catch (e) {
                console.error("Error submitting report:", e);
                alertBox(`Error submitting report: ${e.message}`, 'error');
            }
        }
        
        async function deleteConsultationReport(docId) {
             if (userRole !== 'admin') {
                alertBox("Only Admins can delete consultation reports.", 'error');
                return;
            }
            if (!confirm('Are you sure you want to delete this consultation report?')) return;

            try {
                const reportRef = doc(db, getCollectionPath(REPORTS_COLLECTION), docId);
                await deleteDoc(reportRef);
                alertBox("Report deleted.", 'success');
            } catch (e) {
                console.error("Error deleting report:", e);
                alertBox("Failed to delete report.", 'error');
            }
        }

        function renderConsultationReports(reports) {
            const listEl = document.getElementById('consultation-reports-list');
            listEl.innerHTML = ''; 

            if (reports.length === 0) {
                listEl.innerHTML = '<p class="text-gray-500 col-span-full">No consultation reports available.</p>';
                return;
            }

            reports.sort((a, b) => new Date(b.reportedAt) - new Date(a.reportedAt));

            reports.forEach(report => {
                const card = document.createElement('div');
                card.className = 'dashboard-card p-4 rounded-lg border-l-4 border-green-500 shadow-md';
                
                const deleteButton = userRole === 'admin' ? `
                    <button onclick="deleteConsultationReport('${report.id}')"
                            class="text-red-500 hover:text-red-700 font-medium text-xs">
                        Delete
                    </button>` : '';

                card.innerHTML = `
                    <div class="flex justify-between items-start">
                        <p class="text-lg font-bold text-green-700 mb-1">ID: ${report.patientId}</p>
                        ${deleteButton}
                    </div>
                    <p class="text-gray-800 text-sm mb-2 line-clamp-2">${report.summary}</p>
                    <p class="text-xs text-gray-500">Reported by: ${report.reportedBy.substring(0, 4)}... on ${new Date(report.reportedAt).toLocaleDateString()}</p>
                `;
                listEl.appendChild(card);
            });
        }
        
        // --- Global Tasks Functions (Simplified for this update) ---
        
        async function addGlobalTask() {
            if (userRole !== 'admin') {
                alertBox("Only Admins can add global tasks.", 'error');
                return;
            }
            const input = document.getElementById('new-task-input');
            const taskText = input.value.trim();
            if (!taskText) return;

            try {
                const tasksRef = collection(db, getCollectionPath(TASKS_COLLECTION));
                await addDoc(tasksRef, {
                    task: taskText,
                    createdAt: new Date().toISOString(),
                    completed: false
                });
                input.value = '';
                alertBox("Global task added.", 'success');
            } catch (e) {
                console.error("Error adding task:", e);
                alertBox("Failed to add task.", 'error');
            }
        }
        
        async function deleteGlobalTask(docId) {
            if (userRole !== 'admin') {
                alertBox("Only Admins can delete global tasks.", 'error');
                return;
            }
            try {
                const taskRef = doc(db, getCollectionPath(TASKS_COLLECTION), docId);
                await deleteDoc(taskRef);
                alertBox("Task deleted.", 'success');
            } catch (e) {
                console.error("Error deleting task:", e);
                alertBox("Failed to delete task.", 'error');
            }
        }

        function renderGlobalTasks(tasks) {
            const listEl = document.getElementById('tasks-list');
            listEl.innerHTML = '';
            
            if (tasks.length === 0) {
                listEl.innerHTML = '<p class="text-gray-500">No global tasks.</p>';
                return;
            }

            tasks.sort((a, b) => new Date(a.createdAt) - new Date(b.createdAt));

            tasks.forEach(task => {
                const taskItem = document.createElement('div');
                taskItem.className = 'flex items-center justify-between p-3 bg-gray-50 rounded-lg shadow-sm border border-gray-200';
                
                const deleteButton = userRole === 'admin' ? `
                    <button onclick="deleteGlobalTask('${task.id}')"
                            class="text-red-500 hover:text-red-700 ml-2">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                    </button>` : '';

                taskItem.innerHTML = `
                    <p class="text-sm text-gray-700">${task.task}</p>
                    ${deleteButton}
                `;
                listEl.appendChild(taskItem);
            });
        }
        
        // --- Expose functions to the global scope for event handlers ---
        window.addNewPatient = addNewPatient;
        window.updatePatientStatus = updatePatientStatus;
        window.showAddPatientModal = showAddPatientModal;
        window.closeAddPatientModal = closeAddPatientModal;
        window.showEditPatientModal = showEditPatientModal;
        window.closeEditPatientModal = closeEditPatientModal;
        window.updatePatientDetails = updatePatientDetails; // New
        window.alertBox = alertBox;
        window.showConsultationModal = showConsultationModal;
        window.closeConsultationModal = closeConsultationModal;
        window.submitConsultationReport = submitConsultationReport;
        window.addGlobalTask = addGlobalTask;     
        window.deleteGlobalTask = deleteGlobalTask; 
        window.deleteConsultationReport = deleteConsultationReport; 
        

        // Listen for form submissions
        document.addEventListener('DOMContentLoaded', () => {
            // New Patient Form
            const addPatientForm = document.getElementById('add-patient-form');
            if (addPatientForm) {
                addPatientForm.addEventListener('submit', window.addNewPatient);
            }
            
            // Edit Patient Form (NEW)
            const editPatientForm = document.getElementById('edit-patient-form');
            if (editPatientForm) {
                editPatientForm.addEventListener('submit', window.updatePatientDetails);
            }
            
            // Consultation Form
            const consultationForm = document.getElementById('consultation-form');
            if (consultationForm) {
                consultationForm.addEventListener('submit', window.submitConsultationReport);
            }
        });

        // 1. Initial Auth Check (before Firebase is even initialized)
        checkAuthAndRedirect(); 

        // 2. Initialize Firebase and listeners on window load
        window.onload = initFirebase;
    </script>
</body>
</html>
