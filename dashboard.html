<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Clinic Dashboard</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-50">
  <header class="bg-indigo-700 text-white p-4 text-center text-2xl font-semibold">
    Clinic Dashboard
  </header>

  <main class="p-6">
    <div id="loading" class="text-indigo-600 font-semibold text-center py-12">
      Connecting to Firebase and loading dashboard data...
    </div>
    <div id="content" class="hidden">
      <section class="bg-white rounded-xl shadow p-6 mb-6">
        <h2 class="text-xl font-bold mb-4 text-indigo-700">Add New Patient</h2>
        <form id="add-patient-form" class="space-y-4">
          <input id="patient-name" placeholder="Patient Name" class="w-full border p-2 rounded" required>
          <input id="patient-reason" placeholder="Reason for Visit" class="w-full border p-2 rounded" required>
          <input id="patient-room" placeholder="Room (Optional)" class="w-full border p-2 rounded">
          <button type="submit" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded">Add Patient</button>
        </form>
      </section>

      <section class="bg-white rounded-xl shadow p-6">
        <h2 class="text-xl font-bold mb-4 text-red-700">Submit Consultation Report</h2>
        <form id="consultation-form" class="space-y-4">
          <input id="report-title" placeholder="Report Title" class="w-full border p-2 rounded" required>
          <textarea id="report-content" placeholder="Report Content" rows="5" class="w-full border p-2 rounded" required></textarea>
          <button type="submit" class="bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded">Submit Report</button>
        </form>
      </section>
    </div>
  </main>

  <!-- Firebase Initialization -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getFirestore, collection, addDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";

    const firebaseConfig = {
      apiKey: "AIzaSyBMuundp1Kc1P9Ear0_akWTzUIS3slPizI",
      authDomain: "clinic-system-1579b.firebaseapp.com",
      projectId: "clinic-system-1579b",
      storageBucket: "clinic-system-1579b.firebasestorage.app",
      messagingSenderId: "211282606869",
      appId: "1:211282606869:web:853ddeee9ddba036b1c71c",
      measurementId: "G-B2GSH85BMT"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);

    window.addNewPatient = async function (event) {
      event.preventDefault();
      const name = document.getElementById('patient-name').value.trim();
      const reason = document.getElementById('patient-reason').value.trim();
      const room = document.getElementById('patient-room').value.trim() || 'Waiting Area';
      if (!name || !reason) return alert('Please fill in all required fields.');

      const user = auth.currentUser;
      if (!user) return alert('Please log in first.');

      await addDoc(collection(db, 'artifacts/clinic-default-app/public/data/patients'), {
        name,
        reason,
        room,
        status: 'In Waiting',
        createdByUserId: user.uid,
        createdByRole: 'nurse',
        createdAt: serverTimestamp()
      });
      alert('Patient added successfully!');
      document.getElementById('add-patient-form').reset();
    };

    window.submitConsultationReport = async function (event) {
      event.preventDefault();
      const title = document.getElementById('report-title').value.trim();
      const content = document.getElementById('report-content').value.trim();
      if (!title || !content) return alert('Please complete the report fields.');

      const user = auth.currentUser;
      if (!user) return alert('Please log in first.');

      await addDoc(collection(db, 'artifacts/clinic-default-app/public/data/consultations'), {
        title,
        content,
        submittedById: user.uid,
        submittedBy: user.displayName || 'Nurse User',
        timestamp: serverTimestamp()
      });
      alert('Consultation report submitted successfully!');
      document.getElementById('consultation-form').reset();
    };

    onAuthStateChanged(auth, (user) => {
      const loading = document.getElementById('loading');
      const content = document.getElementById('content');

      if (!user) {
        loading.textContent = 'No authenticated user found. Please log in first.';
        console.warn('No Firebase user detected.');
        setTimeout(() => window.location.href = 'index.html', 1500);
        return;
      }

      console.log('âœ… Logged in as:', user.uid);
      loading.classList.add('hidden');
      content.classList.remove('hidden');

      document.getElementById('add-patient-form').addEventListener('submit', window.addNewPatient);
      document.getElementById('consultation-form').addEventListener('submit', window.submitConsultationReport);
    });
  </script>
</body>
</html>
