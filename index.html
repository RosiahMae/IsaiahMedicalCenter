<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Clinic Management System</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Load Font Awesome for Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Load Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, addDoc, updateDoc, deleteDoc, onSnapshot, collection, query, serverTimestamp, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // IMPORTANT: Global variables from the Canvas environment
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
        
        // Firestore path helpers
        const PUBLIC_COLLECTION_PATH = (collectionName) => `artifacts/${appId}/public/data/${collectionName}`;

        // Global State & Services
        const state = {
            currentPage: 'dashboard',
            user: { id: null, name: "Loading...", role: "Loading..." },
            patients: [],
            medicines: [],
            consultations: [],
            isAuthReady: false
        };

        let db, auth;

        // Utility Functions
        const formatTimestamp = (timestamp) => {
            if (!timestamp) return 'N/A';
            // Firestore timestamp object has to be converted to milliseconds
            const date = timestamp.toDate ? timestamp.toDate() : new Date(timestamp);
            return date.toLocaleDateString('en-US', {
                year: 'numeric', month: 'short', day: 'numeric',
                hour: '2-digit', minute: '2-digit'
            });
        };

        const renderApp = () => {
            // Update User Info in Top Bar
            const userElement = document.getElementById('user-info-display');
            if (userElement) {
                userElement.textContent = `${state.user.name} (${state.user.role})`;
            }

            // Update Sidebar Active Link
            document.querySelectorAll('.sidebar-link').forEach(link => {
                link.classList.remove('bg-sky-700', 'text-white');
                link.classList.add('hover:bg-sky-600');
                if (link.dataset.page === state.currentPage) {
                    link.classList.add('bg-sky-700', 'text-white');
                    link.classList.remove('hover:bg-sky-600');
                }
            });

            const contentArea = document.getElementById('content-area');
            if (!contentArea) return;
            let html = '';
            let title = '';

            switch (state.currentPage) {
                case 'dashboard':
                    title = 'Dashboard';
                    html = renderDashboard();
                    break;
                case 'patients':
                    title = 'Patient Records';
                    html = renderPatients();
                    break;
                case 'inventory':
                    title = 'Medicine Inventory';
                    html = renderInventory();
                    break;
                case 'consultations':
                    title = 'Consultations';
                    html = renderConsultations();
                    break;
                default:
                    title = 'Not Found';
                    html = `<div class="p-6 text-center text-gray-500">Page not found.</div>`;
            }
            document.getElementById('page-title-display').textContent = title;
            contentArea.innerHTML = html;
            attachListeners(); // Re-attach event listeners after rendering new content
        };

        const navigateTo = (page) => {
            state.currentPage = page;
            renderApp();
        };

        // --- Core Application Functions ---

        async function initializeFirebase() {
            setLogLevel('debug'); // Enable Firestore logging
            const app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            auth = getAuth(app);

            // Authentication
            try {
                if (initialAuthToken) {
                    const userCredential = await signInWithCustomToken(auth, initialAuthToken);
                    state.user.id = userCredential.user.uid;
                    state.user.name = 'Clinic Administrator'; // Placeholder user data
                    state.user.role = 'Admin';
                    console.log("Signed in with custom token. User ID:", state.user.id);
                } else {
                    const userCredential = await signInAnonymously(auth);
                    state.user.id = userCredential.user.uid;
                    state.user.name = 'Anonymous Nurse';
                    state.user.role = 'Nurse';
                    console.log("Signed in anonymously. User ID:", state.user.id);
                }
                state.isAuthReady = true;
                startRealtimeListeners();
            } catch (error) {
                console.error("Firebase Auth Error:", error);
                // Fallback state
                state.isAuthReady = true;
                state.user.name = 'Auth Failed';
                renderApp();
            }

            renderApp();
        }

        function startRealtimeListeners() {
            if (!db) return;

            // 1. Patients Listener
            onSnapshot(collection(db, PUBLIC_COLLECTION_PATH('patients')), (snapshot) => {
                state.patients = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                if (state.currentPage === 'patients' || state.currentPage === 'dashboard') {
                    renderApp();
                }
                console.log("Patients updated:", state.patients.length);
            }, (error) => console.error("Patients snapshot error:", error));

            // 2. Medicines Listener
            onSnapshot(collection(db, PUBLIC_COLLECTION_PATH('medicines')), (snapshot) => {
                state.medicines = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                if (state.currentPage === 'inventory' || state.currentPage === 'dashboard') {
                    renderApp();
                }
                console.log("Medicines updated:", state.medicines.length);
            }, (error) => console.error("Medicines snapshot error:", error));

            // 3. Consultations Listener
            onSnapshot(query(collection(db, PUBLIC_COLLECTION_PATH('consultations'))), (snapshot) => {
                // Sort by date manually as orderBy might require an index and throw error
                state.consultations = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }))
                    .sort((a, b) => {
                        const dateA = a.consultationDate?.toDate ? a.consultationDate.toDate().getTime() : 0;
                        const dateB = b.consultationDate?.toDate ? b.consultationDate.toDate().getTime() : 0;
                        return dateB - dateA; // Descending order
                    });
                if (state.currentPage === 'consultations' || state.currentPage === 'dashboard') {
                    renderApp();
                }
                console.log("Consultations updated:", state.consultations.length);
            }, (error) => console.error("Consultations snapshot error:", error));
        }


        // --- Render Views ---

        const renderDashboard = () => {
            const totalPatients = state.patients.length;
            const totalMedicines = state.medicines.length;
            const consultationsToday = state.consultations.filter(c => {
                const date = c.consultationDate?.toDate ? c.consultationDate.toDate() : new Date();
                return date.toDateString() === new Date().toDateString();
            }).length;

            return `
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                    ${createStatCard('Total Patients', totalPatients, 'fas fa-user-injured', 'bg-blue-500')}
                    ${createStatCard('Medicines in Stock', totalMedicines, 'fas fa-pills', 'bg-green-500')}
                    ${createStatCard('Consultations Today', consultationsToday, 'fas fa-stethoscope', 'bg-red-500')}
                </div>

                <h2 class="text-xl font-semibold text-gray-700 mb-4 border-b pb-2">Recent Consultations</h2>
                <div class="overflow-x-auto bg-white p-4 rounded-lg shadow-md">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Date</th>
                                <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Patient Name</th>
                                <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Diagnosis</th>
                            </tr>
                        </thead>
                        <tbody class="divide-y divide-gray-200">
                            ${state.consultations.slice(0, 5).map(c => `
                                <tr class="hover:bg-gray-50">
                                    <td class="px-4 py-2 whitespace-nowrap">${formatTimestamp(c.consultationDate)}</td>
                                    <td class="px-4 py-2 whitespace-nowrap font-medium">${c.patientName}</td>
                                    <td class="px-4 py-2 text-sm text-gray-600 truncate max-w-xs">${c.diagnosis}</td>
                                </tr>
                            `).join('')}
                            ${state.consultations.length === 0 ? '<tr><td colspan="3" class="px-4 py-2 text-center text-gray-500">No recent consultations.</td></tr>' : ''}
                        </tbody>
                    </table>
                </div>
            `;
        };

        const renderPatients = () => {
            return `
                <div class="flex justify-between items-center mb-6">
                    <input type="text" placeholder="Search patients..." class="p-2 border border-gray-300 rounded-lg w-full max-w-xs focus:ring-sky-500 focus:border-sky-500">
                    <button data-modal-target="patientModal" class="bg-sky-600 hover:bg-sky-700 text-white font-bold py-2 px-4 rounded-lg shadow transition duration-150">
                        <i class="fas fa-plus mr-2"></i>Add New Patient
                    </button>
                </div>

                <div class="overflow-x-auto bg-white p-4 rounded-lg shadow-md">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="table-th">ID Number</th>
                                <th class="table-th">Full Name</th>
                                <th class="table-th">Type</th>
                                <th class="table-th">Course/Department</th>
                                <th class="table-th">Actions</th>
                            </tr>
                        </thead>
                        <tbody class="divide-y divide-gray-200">
                            ${state.patients.map(p => `
                                <tr class="hover:bg-gray-50">
                                    <td class="table-td font-mono text-xs">${p.idNumber}</td>
                                    <td class="table-td font-medium">${p.fullName}</td>
                                    <td class="table-td">
                                        <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${p.patientType === 'student' ? 'bg-indigo-100 text-indigo-800' : p.patientType === 'faculty' ? 'bg-yellow-100 text-yellow-800' : 'bg-gray-100 text-gray-800'}">
                                            ${p.patientType.charAt(0).toUpperCase() + p.patientType.slice(1)}
                                        </span>
                                    </td>
                                    <td class="table-td">${p.courseDepartment || 'N/A'}</td>
                                    <td class="table-td space-x-2">
                                        <button data-id="${p.id}" data-action="delete-patient" class="text-red-500 hover:text-red-700 transition duration-150"><i class="fas fa-trash-alt"></i></button>
                                        <button data-id="${p.id}" data-action="view-patient" class="text-sky-500 hover:text-sky-700 transition duration-150"><i class="fas fa-eye"></i></button>
                                    </td>
                                </tr>
                            `).join('')}
                            ${state.patients.length === 0 ? '<tr><td colspan="5" class="px-4 py-2 text-center text-gray-500">No patient records found.</td></tr>' : ''}
                        </tbody>
                    </table>
                </div>
            `;
        };

        const renderInventory = () => {
            return `
                <div class="flex justify-between items-center mb-6">
                    <input type="text" placeholder="Search medicines..." class="p-2 border border-gray-300 rounded-lg w-full max-w-xs focus:ring-sky-500 focus:border-sky-500">
                    <button data-modal-target="inventoryModal" class="bg-sky-600 hover:bg-sky-700 text-white font-bold py-2 px-4 rounded-lg shadow transition duration-150">
                        <i class="fas fa-plus mr-2"></i>Add New Medicine
                    </button>
                </div>

                <div class="overflow-x-auto bg-white p-4 rounded-lg shadow-md">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="table-th">Name</th>
                                <th class="table-th">Description</th>
                                <th class="table-th">Stock</th>
                                <th class="table-th">Unit</th>
                                <th class="table-th">Actions</th>
                            </tr>
                        </thead>
                        <tbody class="divide-y divide-gray-200">
                            ${state.medicines.map(m => `
                                <tr class="hover:bg-gray-50 ${m.stock < 10 ? 'bg-red-50/70' : ''}">
                                    <td class="table-td font-medium">${m.name}</td>
                                    <td class="table-td text-sm text-gray-600 max-w-xs truncate">${m.description}</td>
                                    <td class="table-td text-center ${m.stock < 10 ? 'font-bold text-red-600' : ''}">${m.stock}</td>
                                    <td class="table-td">${m.unit}</td>
                                    <td class="table-td space-x-2">
                                        <button data-id="${m.id}" data-action="adjust-stock" class="text-green-500 hover:text-green-700 transition duration-150" title="Adjust Stock"><i class="fas fa-box"></i></button>
                                        <button data-id="${m.id}" data-action="delete-medicine" class="text-red-500 hover:text-red-700 transition duration-150" title="Delete Medicine"><i class="fas fa-trash-alt"></i></button>
                                    </td>
                                </tr>
                            `).join('')}
                            ${state.medicines.length === 0 ? '<tr><td colspan="5" class="px-4 py-2 text-center text-gray-500">No medicines in inventory.</td></tr>' : ''}
                        </tbody>
                    </table>
                </div>
            `;
        };

        const renderConsultations = () => {
            return `
                <div class="flex justify-between items-center mb-6">
                    <input type="text" placeholder="Search consultations..." class="p-2 border border-gray-300 rounded-lg w-full max-w-xs focus:ring-sky-500 focus:border-sky-500">
                    <button data-modal-target="consultationModal" class="bg-sky-600 hover:bg-sky-700 text-white font-bold py-2 px-4 rounded-lg shadow transition duration-150">
                        <i class="fas fa-plus mr-2"></i>Log New Consultation
                    </button>
                </div>

                <div class="overflow-x-auto bg-white p-4 rounded-lg shadow-md">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="table-th">Date</th>
                                <th class="table-th">Patient Name</th>
                                <th class="table-th">Diagnosis / Complaint</th>
                                <th class="table-th">Attended By</th>
                                <th class="table-th">Actions</th>
                            </tr>
                        </thead>
                        <tbody class="divide-y divide-gray-200">
                            ${state.consultations.map(c => `
                                <tr class="hover:bg-gray-50">
                                    <td class="table-td font-mono text-xs">${formatTimestamp(c.consultationDate)}</td>
                                    <td class="table-td font-medium">${c.patientName}</td>
                                    <td class="table-td text-sm text-gray-600 max-w-sm">${c.diagnosis}</td>
                                    <td class="table-td text-sm">${c.userName}</td>
                                    <td class="table-td">
                                        <button data-id="${c.id}" data-action="view-consultation" class="text-sky-500 hover:text-sky-700 transition duration-150"><i class="fas fa-file-medical"></i> View</button>
                                    </td>
                                </tr>
                            `).join('')}
                            ${state.consultations.length === 0 ? '<tr><td colspan="5" class="px-4 py-2 text-center text-gray-500">No consultation records found.</td></tr>' : ''}
                        </tbody>
                    </table>
                </div>
            `;
        };

        // Helper for Dashboard Stats
        const createStatCard = (title, value, iconClass, colorClass) => `
            <div class="bg-white p-6 rounded-xl shadow-lg border border-gray-100 flex items-center space-x-4">
                <div class="p-4 rounded-full ${colorClass} text-white">
                    <i class="${iconClass} text-2xl"></i>
                </div>
                <div>
                    <p class="text-sm font-medium text-gray-500">${title}</p>
                    <p class="text-3xl font-bold text-gray-900">${value}</p>
                </div>
            </div>
        `;

        // --- Firebase CRUD Operations ---

        // Patient Form Submission
        const handlePatientSubmit = async (e) => {
            e.preventDefault();
            const form = e.target;
            const data = Object.fromEntries(new FormData(form).entries());

            try {
                const docRef = await addDoc(collection(db, PUBLIC_COLLECTION_PATH('patients')), {
                    ...data,
                    fullName: data.fullName,
                    idNumber: data.idNumber,
                    patientType: data.patientType,
                    dob: data.dob,
                    createdAt: serverTimestamp()
                });
                alert('success', 'Patient added successfully!');
                closeModal('patientModal');
                form.reset();
            } catch (error) {
                console.error("Error adding patient: ", error);
                alert('error', 'Failed to add patient.');
            }
        };

        // Inventory Form Submission
        const handleInventorySubmit = async (e) => {
            e.preventDefault();
            const form = e.target;
            const data = Object.fromEntries(new FormData(form).entries());

            try {
                const docRef = await addDoc(collection(db, PUBLIC_COLLECTION_PATH('medicines')), {
                    ...data,
                    stock: parseInt(data.stock, 10),
                    unit: data.unit,
                    name: data.name,
                    description: data.description,
                    createdAt: serverTimestamp()
                });
                alert('success', 'Medicine added successfully!');
                closeModal('inventoryModal');
                form.reset();
            } catch (error) {
                console.error("Error adding medicine: ", error);
                alert('error', 'Failed to add medicine.');
            }
        };

        // Consultation Form Submission
        const handleConsultationSubmit = async (e) => {
            e.preventDefault();
            const form = e.target;
            const data = Object.fromEntries(new FormData(form).entries());

            // Simple validation for patient selection
            if (!data.patientId) {
                alert('error', 'Please select a patient before logging the consultation.');
                return;
            }

            try {
                const docRef = await addDoc(collection(db, PUBLIC_COLLECTION_PATH('consultations')), {
                    patientId: data.patientId,
                    patientName: data.patientNameDisplay,
                    userId: state.user.id,
                    userName: state.user.name,
                    diagnosis: data.diagnosis,
                    notes: data.notes,
                    consultationDate: serverTimestamp()
                });
                alert('success', 'Consultation logged successfully!');
                closeModal('consultationModal');
                form.reset();
            } catch (error) {
                console.error("Error logging consultation: ", error);
                alert('error', 'Failed to log consultation.');
            }
        };


        // --- UI Interactions & Listeners ---

        const attachListeners = () => {
            // 1. Navigation Links
            document.querySelectorAll('.sidebar-link').forEach(link => {
                link.onclick = (e) => {
                    e.preventDefault();
                    navigateTo(link.dataset.page);
                };
            });

            // 2. Form Submissions (attach once after modal is rendered)
            const patientForm = document.getElementById('patientForm');
            if (patientForm && !patientForm.__listenerAttached) {
                patientForm.addEventListener('submit', handlePatientSubmit);
                patientForm.__listenerAttached = true;
            }
            const inventoryForm = document.getElementById('inventoryForm');
            if (inventoryForm && !inventoryForm.__listenerAttached) {
                inventoryForm.addEventListener('submit', handleInventorySubmit);
                inventoryForm.__listenerAttached = true;
            }
            const consultationForm = document.getElementById('consultationForm');
            if (consultationForm && !consultationForm.__listenerAttached) {
                consultationForm.addEventListener('submit', handleConsultationSubmit);
                consultationForm.__listenerAttached = true;
            }

            // 3. Universal Modal Logic
            document.querySelectorAll('[data-modal-target]').forEach(button => {
                button.onclick = () => {
                    const modalId = button.dataset.modalTarget;
                    document.getElementById(modalId).classList.remove('hidden');
                };
            });
            document.querySelectorAll('.modal-close-btn').forEach(button => {
                button.onclick = () => {
                    closeModal(button.closest('.modal').id);
                };
            });
            // Close modal when clicking outside
            document.querySelectorAll('.modal').forEach(modal => {
                modal.onclick = (e) => {
                    if (e.target === modal) {
                        closeModal(modal.id);
                    }
                };
            });

            // 4. Patient Search/Selection (for Consultation Modal)
            const patientSearchInput = document.getElementById('patient_search_input');
            const searchResultsContainer = document.getElementById('patient_search_results');
            const selectedPatientIdInput = document.getElementById('patient_id_input');
            const selectedPatientNameDisplay = document.getElementById('patient_name_display');

            if (patientSearchInput) {
                patientSearchInput.onkeyup = () => {
                    const term = patientSearchInput.value.toLowerCase();
                    if (term.length < 2) {
                        searchResultsContainer.innerHTML = '';
                        return;
                    }
                    const filtered = state.patients.filter(p =>
                        p.fullName.toLowerCase().includes(term) || p.idNumber.toLowerCase().includes(term)
                    ).slice(0, 5); // Limit to 5 results

                    searchResultsContainer.innerHTML = filtered.map(p => `
                        <div class="p-2 cursor-pointer hover:bg-sky-100 border-b last:border-b-0"
                             data-id="${p.id}"
                             data-name="${p.fullName}">
                            ${p.fullName} <span class="text-xs text-gray-500">(${p.idNumber})</span>
                        </div>
                    `).join('');
                };

                searchResultsContainer.onclick = (e) => {
                    const item = e.target.closest('div[data-id]');
                    if (item) {
                        selectedPatientIdInput.value = item.dataset.id;
                        selectedPatientNameDisplay.value = item.dataset.name;
                        selectedPatientNameDisplay.classList.remove('hidden');
                        patientSearchInput.value = item.dataset.name; // Display selected name
                        searchResultsContainer.innerHTML = ''; // Clear results
                    }
                };
            }

            // 5. Patient Deletion Listener
            document.querySelectorAll('[data-action="delete-patient"]').forEach(btn => {
                btn.onclick = (e) => {
                    const patientId = e.currentTarget.dataset.id;
                    confirmAction('Confirm Deletion', 'Are you sure you want to delete this patient record? This action cannot be undone.', () => {
                        deleteFirestoreDocument(PUBLIC_COLLECTION_PATH('patients'), patientId);
                    });
                };
            });

            // 6. Medicine Deletion Listener
            document.querySelectorAll('[data-action="delete-medicine"]').forEach(btn => {
                btn.onclick = (e) => {
                    const medicineId = e.currentTarget.dataset.id;
                    confirmAction('Confirm Deletion', 'Are you sure you want to delete this medicine from inventory?', () => {
                        deleteFirestoreDocument(PUBLIC_COLLECTION_PATH('medicines'), medicineId);
                    });
                };
            });
        };

        const deleteFirestoreDocument = async (collectionPath, docId) => {
             try {
                await deleteDoc(doc(db, collectionPath, docId));
                alert('success', 'Record deleted successfully.');
             } catch (error) {
                console.error("Error deleting document: ", error);
                alert('error', 'Failed to delete record.');
             }
        };

        const closeModal = (modalId) => {
            const modal = document.getElementById(modalId);
            if (modal) {
                modal.classList.add('hidden');
                // Reset patient search on consultation modal close
                if (modalId === 'consultationModal') {
                    document.getElementById('patient_search_input').value = '';
                    document.getElementById('patient_search_results').innerHTML = '';
                    document.getElementById('patient_id_input').value = '';
                    document.getElementById('patient_name_display').value = '';
                }
            }
        };

        // Custom Alert/Confirmation UI (replaces alert() and confirm())

        const alert = (type, message) => {
            const container = document.getElementById('alertContainer');
            const alertClasses = {
                success: 'bg-green-100 border-green-500 text-green-700',
                error: 'bg-red-100 border-red-500 text-red-700',
                info: 'bg-blue-100 border-blue-500 text-blue-700'
            };
            const alertIcon = {
                success: 'fas fa-check-circle',
                error: 'fas fa-times-circle',
                info: 'fas fa-info-circle'
            };

            const alertDiv = document.createElement('div');
            alertDiv.className = `p-4 border-l-4 rounded-lg shadow-md mb-3 ${alertClasses[type]} flex items-center justify-between`;
            alertDiv.innerHTML = `
                <div class="flex items-center">
                    <i class="${alertIcon[type]} mr-3"></i>
                    <p class="font-medium">${message}</p>
                </div>
                <button class="text-sm font-semibold opacity-70 hover:opacity-100 close-alert">
                    <i class="fas fa-times"></i>
                </button>
            `;

            alertDiv.querySelector('.close-alert').onclick = () => alertDiv.remove();
            container.appendChild(alertDiv);
            setTimeout(() => {
                if (alertDiv.parentNode) alertDiv.remove();
            }, 5000);
        };

        const confirmAction = (title, message, onConfirm) => {
            const modal = document.getElementById('confirmationModal');
            document.getElementById('confirmTitle').textContent = title;
            document.getElementById('confirmMessage').textContent = message;

            const confirmBtn = document.getElementById('confirmButton');
            confirmBtn.onclick = () => {
                onConfirm();
                closeModal('confirmationModal');
            };

            modal.classList.remove('hidden');
        };

        // Initialize on load
        window.onload = initializeFirebase;
    </script>
    <style>
        /* Custom Styles to enhance Tailwind appearance */
        :root {
            --sidebar-bg: #1e293b; /* slate-900 */
            --primary-color: #0ea5e9; /* sky-500 */
        }
        body { font-family: 'Inter', sans-serif; background-color: #f1f5f9; }
        .app-layout { display: flex; min-height: 100vh; }
        .sidebar { background-color: var(--sidebar-bg); width: 16rem; flex-shrink: 0; padding: 1.5rem 0; color: #cbd5e1; }
        .top-bar { background-color: #ffffff; padding: 1rem 1.5rem; border-bottom: 1px solid #e2e8f0; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 1px 3px 0 rgba(0,0,0,.1); }
        .main-content { flex-grow: 1; padding: 1.5rem; }
        .table-th { padding: 0.5rem 1rem; text-left; text-xs; font-medium; text-gray-500; uppercase; tracking-wider; }
        .table-td { padding: 0.5rem 1rem; whitespace-nowrap; text-sm; text-gray-800; }

        /* Modal Styles */
        .modal {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-color: rgba(0, 0, 0, 0.6); z-index: 50;
            display: flex; justify-content: center; align-items: center;
        }
        .modal-content {
            background: #fff; padding: 2rem; border-radius: 0.75rem;
            width: 95%; max-width: 600px; max-height: 90vh; overflow-y: auto;
            position: relative; animation: slideDown 0.3s ease-out;
        }
        .modal-content-large { max-width: 800px; }
        @keyframes slideDown { from { transform: translateY(-50px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }

        /* Patient Search Results Styling */
        #patient_search_results {
            position: absolute; width: calc(100% - 3rem); background-color: white;
            border: 1px solid #e2e8f0; border-radius: 0 0 0.5rem 0.5rem;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); z-index: 10;
        }
        @media (max-width: 768px) {
            .sidebar { width: 100%; height: auto; display: none; }
            .main-content { padding: 1rem; }
            .app-layout { flex-direction: column; }
        }
    </style>
</head>
<body class="bg-gray-100">

    <!-- Global Alert Container -->
    <div id="alertContainer" class="fixed top-4 right-4 z-50 w-full max-w-sm"></div>

    <div class="app-layout">
        <!-- Sidebar Navigation -->
        <aside class="sidebar">
            <div class="flex items-center space-x-3 px-6 mb-8">
                <i class="fas fa-clinic-medical text-3xl text-sky-400"></i>
                <span class="text-xl font-bold text-white">Clinic System</span>
            </div>
            <nav class="space-y-2 px-4">
                <a href="#" data-page="dashboard" class="sidebar-link flex items-center p-3 rounded-lg transition duration-150 hover:bg-sky-600">
                    <i class="fas fa-chart-line mr-3 fa-fw"></i><span>Dashboard</span>
                </a>
                <a href="#" data-page="patients" class="sidebar-link flex items-center p-3 rounded-lg transition duration-150 hover:bg-sky-600">
                    <i class="fas fa-users mr-3 fa-fw"></i><span>Patients</span>
                </a>
                <a href="#" data-page="consultations" class="sidebar-link flex items-center p-3 rounded-lg transition duration-150 hover:bg-sky-600">
                    <i class="fas fa-stethoscope mr-3 fa-fw"></i><span>Consultations</span>
                </a>
                <a href="#" data-page="inventory" class="sidebar-link flex items-center p-3 rounded-lg transition duration-150 hover:bg-sky-600">
                    <i class="fas fa-pills mr-3 fa-fw"></i><span>Inventory</span>
                </a>
            </nav>
            <div class="px-6 mt-8 pt-4 border-t border-slate-700">
                <p class="text-xs text-slate-400 mb-2">Authenticated User ID (For Auditing)</p>
                <code class="text-xs break-all text-sky-300" id="user-id-display">Loading...</code>
            </div>
        </aside>

        <!-- Main Content Area -->
        <div class="flex-grow">
            <!-- Top Bar -->
            <header class="top-bar">
                <h1 class="text-2xl font-semibold text-gray-800" id="page-title-display">Dashboard</h1>
                <div class="flex items-center space-x-3">
                    <span class="text-sm font-medium text-gray-600" id="user-info-display">Loading...</span>
                    <i class="fas fa-user-circle text-2xl text-sky-600"></i>
                </div>
            </header>

            <!-- Content Area -->
            <main class="main-content">
                <!-- Content is injected here by JavaScript -->
                <div id="content-area" class="min-h-[70vh]">
                    <div class="text-center p-12 text-gray-500">
                        <i class="fas fa-spinner fa-spin text-4xl mb-4 text-sky-600"></i>
                        <p class="text-lg font-medium">Loading application and connecting to Firestore...</p>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <!-- --- MODALS --- -->

    <!-- Patient Modal (Add Patient) -->
    <div id="patientModal" class="modal hidden">
        <div class="modal-content modal-content-large">
            <span class="modal-close-btn absolute top-4 right-4 text-gray-400 hover:text-gray-700 cursor-pointer text-2xl">&times;</span>
            <h2 class="text-2xl font-bold mb-6 text-gray-800">Add New Patient Record</h2>
            <form id="patientForm" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div class="col-span-1 md:col-span-2 form-group">
                    <label class="block text-sm font-medium text-gray-700 mb-1">Full Name</label>
                    <input type="text" name="fullName" required class="w-full p-2 border border-gray-300 rounded-lg focus:ring-sky-500 focus:border-sky-500">
                </div>
                <div class="form-group">
                    <label class="block text-sm font-medium text-gray-700 mb-1">ID Number</label>
                    <input type="text" name="idNumber" required class="w-full p-2 border border-gray-300 rounded-lg focus:ring-sky-500 focus:border-sky-500">
                </div>
                <div class="form-group">
                    <label class="block text-sm font-medium text-gray-700 mb-1">Patient Type</label>
                    <select name="patientType" required class="w-full p-2 border border-gray-300 rounded-lg focus:ring-sky-500 focus:border-sky-500 bg-white">
                        <option value="student">Student</option>
                        <option value="faculty">Faculty</option>
                        <option value="staff">Staff</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="block text-sm font-medium text-gray-700 mb-1">Date of Birth</label>
                    <input type="date" name="dob" required class="w-full p-2 border border-gray-300 rounded-lg focus:ring-sky-500 focus:border-sky-500">
                </div>
                <div class="form-group">
                    <label class="block text-sm font-medium text-gray-700 mb-1">Gender</label>
                    <select name="gender" required class="w-full p-2 border border-gray-300 rounded-lg focus:ring-sky-500 focus:border-sky-500 bg-white">
                        <option value="Male">Male</option>
                        <option value="Female">Female</option>
                        <option value="Other">Other</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="block text-sm font-medium text-gray-700 mb-1">Course/Department</label>
                    <input type="text" name="courseDepartment" class="w-full p-2 border border-gray-300 rounded-lg focus:ring-sky-500 focus:border-sky-500">
                </div>
                <div class="form-group">
                    <label class="block text-sm font-medium text-gray-700 mb-1">Contact Number</label>
                    <input type="tel" name="contactNumber" class="w-full p-2 border border-gray-300 rounded-lg focus:ring-sky-500 focus:border-sky-500">
                </div>
                <div class="col-span-1 md:col-span-2 form-group">
                    <label class="block text-sm font-medium text-gray-700 mb-1">Address</label>
                    <textarea name="address" rows="2" class="w-full p-2 border border-gray-300 rounded-lg focus:ring-sky-500 focus:border-sky-500"></textarea>
                </div>
                <div class="col-span-1 md:col-span-2 pt-4">
                    <button type="submit" class="w-full bg-sky-600 hover:bg-sky-700 text-white font-bold py-3 px-4 rounded-lg shadow-md transition duration-150">
                        <i class="fas fa-user-plus mr-2"></i>Save Patient
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Inventory Modal (Add Medicine) -->
    <div id="inventoryModal" class="modal hidden">
        <div class="modal-content">
            <span class="modal-close-btn absolute top-4 right-4 text-gray-400 hover:text-gray-700 cursor-pointer text-2xl">&times;</span>
            <h2 class="text-2xl font-bold mb-6 text-gray-800">Add New Medicine</h2>
            <form id="inventoryForm" class="space-y-4">
                <div class="form-group">
                    <label class="block text-sm font-medium text-gray-700 mb-1">Medicine Name</label>
                    <input type="text" name="name" required class="w-full p-2 border border-gray-300 rounded-lg focus:ring-sky-500 focus:border-sky-500">
                </div>
                <div class="form-group">
                    <label class="block text-sm font-medium text-gray-700 mb-1">Description/Usage</label>
                    <textarea name="description" rows="2" required class="w-full p-2 border border-gray-300 rounded-lg focus:ring-sky-500 focus:border-sky-500"></textarea>
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div class="form-group">
                        <label class="block text-sm font-medium text-gray-700 mb-1">Initial Stock</label>
                        <input type="number" name="stock" value="0" min="0" required class="w-full p-2 border border-gray-300 rounded-lg focus:ring-sky-500 focus:border-sky-500">
                    </div>
                    <div class="form-group">
                        <label class="block text-sm font-medium text-gray-700 mb-1">Unit</label>
                        <select name="unit" required class="w-full p-2 border border-gray-300 rounded-lg focus:ring-sky-500 focus:border-sky-500 bg-white">
                            <option value="tablets">Tablets</option>
                            <option value="capsules">Capsules</option>
                            <option value="mL">mL</option>
                            <option value="vial">Vial</option>
                        </select>
                    </div>
                </div>
                <div class="pt-4">
                    <button type="submit" class="w-full bg-sky-600 hover:bg-sky-700 text-white font-bold py-3 px-4 rounded-lg shadow-md transition duration-150">
                        <i class="fas fa-box-open mr-2"></i>Add to Inventory
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Consultation Modal (Log Consultation) -->
    <div id="consultationModal" class="modal hidden">
        <div class="modal-content modal-content-large">
            <span class="modal-close-btn absolute top-4 right-4 text-gray-400 hover:text-gray-700 cursor-pointer text-2xl">&times;</span>
            <h2 class="text-2xl font-bold mb-6 text-gray-800">Log New Consultation</h2>
            <form id="consultationForm" class="space-y-4">
                <!-- Patient Search Group -->
                <div class="form-group relative">
                    <label class="block text-sm font-medium text-gray-700 mb-1">Search & Select Patient (Required)</label>
                    <input type="text" id="patient_search_input" placeholder="Start typing patient name or ID..." required class="w-full p-2 border border-gray-300 rounded-t-lg focus:ring-sky-500 focus:border-sky-500">
                    <div id="patient_search_results" class="absolute w-full mt-0 z-10"></div>
                    <!-- Hidden inputs for selected patient data -->
                    <input type="hidden" id="patient_id_input" name="patientId" required>
                    <input type="hidden" id="patient_name_display" name="patientNameDisplay" required>
                </div>

                <div class="form-group">
                    <label class="block text-sm font-medium text-gray-700 mb-1">Diagnosis / Complaint</label>
                    <input type="text" name="diagnosis" required class="w-full p-2 border border-gray-300 rounded-lg focus:ring-sky-500 focus:border-sky-500">
                </div>
                <div class="form-group">
                    <label class="block text-sm font-medium text-gray-700 mb-1">Treatment & Notes</label>
                    <textarea name="notes" rows="4" required class="w-full p-2 border border-gray-300 rounded-lg focus:ring-sky-500 focus:border-sky-500"></textarea>
                </div>
                <div class="pt-4">
                    <button type="submit" class="w-full bg-sky-600 hover:bg-sky-700 text-white font-bold py-3 px-4 rounded-lg shadow-md transition duration-150">
                        <i class="fas fa-calendar-check mr-2"></i>Submit Consultation
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Confirmation Modal (replaces confirm()) -->
    <div id="confirmationModal" class="modal hidden">
        <div class="modal-content max-w-sm">
            <span class="modal-close-btn absolute top-4 right-4 text-gray-400 hover:text-gray-700 cursor-pointer text-2xl">&times;</span>
            <h2 class="text-xl font-bold mb-4 text-gray-800" id="confirmTitle">Confirm Action</h2>
            <p class="text-gray-600 mb-6" id="confirmMessage">Are you sure you want to proceed?</p>
            <div class="flex justify-end space-x-3">
                <button onclick="closeModal('confirmationModal')" class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-2 px-4 rounded-lg transition duration-150">
                    Cancel
                </button>
                <button id="confirmButton" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg shadow-md transition duration-150">
                    Confirm
                </button>
            </div>
        </div>
    </div>

</body>
</html>
