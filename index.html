<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Clinic System Login</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Inter Font -->
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f8f9fa; }
    </style>
</head>
<body class="min-h-screen flex items-center justify-center p-4">
    <div id="login-container" class="bg-white p-8 rounded-xl shadow-2xl w-full max-w-md transition-all duration-300">
        <h1 class="text-3xl font-extrabold text-indigo-700 text-center mb-6">Clinic Access</h1>
        <p id="status-message" class="text-center text-gray-600 mb-6">Connecting to system...</p>
        
        <div id="loading-spinner" class="flex justify-center items-center h-20">
            <svg class="animate-spin -ml-1 mr-3 h-8 w-8 text-indigo-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
        </div>
        
        <div id="login-form" class="hidden">
            <h2 class="text-xl font-semibold text-gray-700 mb-4">Role Verification</h2>
            <p class="text-sm text-gray-500 mb-4">
                Enter your unique User ID/Key. Admins can leave the field blank (which uses the default Admin key).
            </p>
            
            <div class="mb-4">
                <label for="user-id-input" class="block text-sm font-medium text-gray-700">User ID/Key</label>
                <input type="text" id="user-id-input" placeholder="Enter key (e.g., nurse_ambe_ilona) or leave blank for Admin."
                    class="mt-1 block w-full border border-gray-300 rounded-lg shadow-sm p-3 focus:ring-indigo-500 focus:border-indigo-500">
            </div>

            <button id="login-button" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 rounded-lg shadow-md transition-colors duration-200">
                Proceed to Dashboard
            </button>
        </div>

        <p id="error-message" class="text-center text-sm text-red-500 mt-4 hidden"></p>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, collection, getDocs } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- FIXED ROLE KEYS ---
        const ADMIN_KEY = 'admin_system_key';
        
        // --- HARDCODED CONFIGURATION for GitHub Pages DEPLOYMENT (YOUR CONFIG) ---
        const YOUR_FIREBASE_CONFIG = {
            apiKey: "AIzaSyBMuundp1Kc1P9Ear0_akWTzUIS3slPizI",
            authDomain: "clinic-system-1579b.firebaseapp.com",
            projectId: "clinic-system-1579b",
            storageBucket: "clinic-system-1579b.firebasestorage.app",
            messagingSenderId: "211282606869",
            appId: "1:211282606869:web:853ddeee9ddba036b1c71c",
            measurementId: "G-B2GSH85BMT"
        };
        
        // Global variables provided by the Canvas environment
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'clinic-default-app';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : YOUR_FIREBASE_CONFIG; 
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        const statusMessage = document.getElementById('status-message');
        const loadingSpinner = document.getElementById('loading-spinner');
        const loginForm = document.getElementById('login-form');
        const errorMessage = document.getElementById('error-message');
        const loginButton = document.getElementById('login-button');
        const userIdInput = document.getElementById('user-id-input');

        let db = null;
        let auth = null;
        let authenticatedUserId = null; // The UID from the current Firebase session

        // --- Utility Functions ---

        // Generate 50 unique medicine items for inventory seeding
        function generateInventory() {
            const medicines = [
                "Amoxicillin 250mg", "Ibuprofen 200mg", "Paracetamol 500mg", "Lisinopril 10mg", "Metformin 500mg",
                "Aspirin 81mg", "Atorvastatin 20mg", "Amlodipine 5mg", "Levothyroxine 50mcg", "Omeprazole 20mg"
            ];
            const units = ["pills", "tablets", "capsules", "mL"];
            const inventory = {};
            for (let i = 1; i <= 50; i++) {
                const nameIndex = (i - 1) % medicines.length;
                const unitIndex = Math.floor((i - 1) / medicines.length) % units.length;
                const baseName = medicines[nameIndex];
                const unit = units[unitIndex];
                
                // Add unique identifier to ensure 50 distinct items
                const uniqueName = `${baseName} (Batch ${Math.ceil(i/5)})`; 
                
                inventory[`item${i}`] = {
                    name: uniqueName,
                    quantity: 50 + Math.floor(Math.random() * 50),
                    unit: unit,
                    price: (Math.random() * 10 + 1).toFixed(2),
                    id: `inv-${i}`
                };
            }
            return inventory;
        }

        // --- Firebase Core Logic ---

        async function seedInitialData() {
            const rolesCollectionRef = collection(db, `artifacts/${appId}/public/data/roles`);
            const inventoryCollectionRef = collection(db, `artifacts/${appId}/public/data/inventory`);
            
            // 1. Check specifically if the ADMIN_KEY role document exists.
            const adminDocRef = doc(rolesCollectionRef, ADMIN_KEY);
            const adminDoc = await getDoc(adminDocRef);

            if (!adminDoc.exists()) { // Only seed if the Admin key is missing
                statusMessage.textContent = "Seeding initial roles and inventory (One-time setup)...";

                try {
                    // A. Seed Roles - Admin now uses a fixed key
                    const rolesData = [
                        { uid: ADMIN_KEY, role: "admin", name: "System Admin (Me)" },
                        { uid: `nurse_anne_margarette`, role: "nurse", name: "Anne Margarette" },
                        { uid: `nurse_ambe_ilona`, role: "nurse", name: "Ambe Ilona" },
                    ];
                    
                    for (const role of rolesData) {
                        await setDoc(doc(rolesCollectionRef, role.uid), { role: role.role, name: role.name });
                    }

                    // B. Seed Inventory (50 items)
                    const inventoryData = generateInventory();
                    for (const id in inventoryData) {
                        await setDoc(doc(inventoryCollectionRef, inventoryData[id].id), inventoryData[id]);
                    }

                    statusMessage.textContent = "Data seeding complete. Please proceed to login.";
                } catch (e) {
                    console.error("Seeding Failed:", e);
                    // Display the error prominently if the seeding fails
                    errorMessage.textContent = `CRITICAL: Initial data seeding failed. Please check your Firestore Security Rules. Error: ${e.message}`;
                    errorMessage.classList.remove('hidden');
                    // Prevent login form from showing if we can't seed the roles
                    loadingSpinner.classList.add('hidden');
                    return false; // Seeding failed
                }
            }
            return true; // Seeding was skipped or succeeded
        }

        async function checkUserRoleAndRedirect(uidToCheck) {
            // Trim and sanitize the input ID
            const cleanUid = uidToCheck.trim().toLowerCase();

            const roleDocRef = doc(db, `artifacts/${appId}/public/data/roles`, cleanUid);
            const roleDoc = await getDoc(roleDocRef);

            let userRole = null;
            if (roleDoc.exists()) {
                userRole = roleDoc.data().role;
            }

            if (userRole) {
                // Store the REAL Firebase UID for Firestore access/security checks, 
                // and the validated user details for the application logic.
                sessionStorage.setItem('clinic_auth_uid', authenticatedUserId); // Real Firebase UID
                sessionStorage.setItem('clinic_user_key', cleanUid); // The key used for role lookup
                sessionStorage.setItem('clinic_user_role', userRole);
                sessionStorage.setItem('clinic_user_name', roleDoc.data().name);
                
                statusMessage.textContent = `Login successful. Redirecting as ${roleDoc.data().name.toUpperCase()}...`;
                window.location.href = 'dashboard.html';
            } else {
                errorMessage.textContent = `Error: User ID/Key "${cleanUid}" not found or not configured with a role (admin/nurse). This key must exist in the 'roles' collection.`;
                errorMessage.classList.remove('hidden');
                loginButton.disabled = false;
            }
        }
        
        function handleLoginAttempt() {
            errorMessage.classList.add('hidden');
            loginButton.disabled = true;
            const enteredId = userIdInput.value;
            
            // If the input is empty, default to the fixed Admin key
            const uidToCheck = enteredId.trim() ? enteredId : ADMIN_KEY;
            
            checkUserRoleAndRedirect(uidToCheck);
        }

        // --- Initialization ---

        function initFirebase() {
            if (!firebaseConfig) {
                errorMessage.textContent = "Error: Firebase configuration not found.";
                errorMessage.classList.remove('hidden');
                loadingSpinner.classList.add('hidden');
                return;
            }
            
            console.log("Using Firebase Config:", firebaseConfig);

            try {
                // Initialize App and Services
                const app = initializeApp(firebaseConfig);
                auth = getAuth(app); 
                db = getFirestore(app);
                
                // 1. Listen for Auth State Change
                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        authenticatedUserId = user.uid; // Store the actual Firebase UID
                        statusMessage.textContent = `Authenticated (Ready to check ID).`;
                        
                        // 2. Seed data: Run seeding logic
                        const seedSuccess = await seedInitialData();
                        
                        if (seedSuccess) {
                            loadingSpinner.classList.add('hidden');
                            loginForm.classList.remove('hidden');
                            
                            // 3. Attach the new login handler
                            loginButton.onclick = handleLoginAttempt;
                        }
                        
                    } else {
                        statusMessage.textContent = "Attempting sign-in...";
                        
                        // 3. Authenticate using the token (Canvas) or anonymously (GitHub Pages)
                        try {
                            if (initialAuthToken) {
                                await signInWithCustomToken(auth, initialAuthToken);
                            } else {
                                await signInAnonymously(auth);
                            }
                        } catch (e) {
                            console.error("Authentication failed:", e);
                            errorMessage.textContent = `Authentication failed: ${e.message}. Please ensure Anonymous Sign-In is enabled in your Firebase Console.`;
                            errorMessage.classList.remove('hidden');
                            loadingSpinner.classList.add('hidden');
                        }
                    }
                });

            } catch (e) {
                console.error("Firebase initialization failed:", e);
                errorMessage.textContent = `Firebase initialization failed: ${e.message}`;
                errorMessage.classList.remove('hidden');
                loadingSpinner.classList.add('hidden');
            }
        }

        // Wait for the window to load before starting
        window.onload = initFirebase;
    </script>
</body>
</html>
